<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://cdn.baomitu.com/index/fonts/css?family=Ma Shan Zheng:300,300italic,400,400italic,700,700italic|Noto Sans Simplified Chinese:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|Monaco:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lib.baomitu.com/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//lib.baomitu.com/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="//lib.baomitu.com/pace/1.0.2/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xuemingde.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":true,"sidebar":{"position":"left","width":300,"display":"always","padding":18,"offset":10,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="我的愿望，世界和平">
<meta property="og:type" content="website">
<meta property="og:title" content="Middle&#39;s blog">
<meta property="og:url" content="https://xuemingde.com/page/10/index.html">
<meta property="og:site_name" content="Middle&#39;s blog">
<meta property="og:description" content="我的愿望，世界和平">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="meadel">
<meta property="article:tag" content="meadel">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://xuemingde.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Middle's blog - 一位程序员的成长之路</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Middle's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一位程序员的成长之路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-notepad">

    <a href="/notepad/" rel="section"><i class="fa fa-book fa-fw"></i>备忘录</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源库</a>

  </li>
        <li class="menu-item menu-item-collect">

    <a href="/collect/" rel="section"><i class="fa fa-star fa-fw"></i>收藏夹</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

           <div id="container-1">
            <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xuemingde.com/posts/2ZZM48T.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="meadel">
      <meta itemprop="description" content="我的愿望，世界和平">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Middle's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2ZZM48T.html" class="post-title-link" itemprop="url">Column注解解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-06 00:00:00" itemprop="dateCreated datePublished" datetime="2022-05-06T00:00:00+08:00">2022-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-13 16:46:48" itemprop="dateModified" datetime="2022-08-13T16:46:48+08:00">2022-08-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">JAVA基础</span></a>
                </span>
            </span>

          
            <span id="/posts/2ZZM48T.html" class="post-meta-item leancloud_visitors" data-flag-title="Column注解解析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/2ZZM48T.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/2ZZM48T.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>功能：@Column注解用来标识实体类中属性与数据表中字段的对应关系<br>语法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Column(columnDefinition = &quot;bigint(18)  comment &#x27;公司ID&#x27;&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> Long ouId;</span><br><span class="line"><span class="comment">//columnDefinition表示创建表时，该字段创建的SQL语句，一般用于通过Entity生成表定义时使用。（也就是说，如果DB中表已经建好了，该属性就没有必要使用了）</span></span><br><span class="line"><span class="comment">//comment(注释的意思-我这个文盲硬生生以为是@Column里面带的，类似于name属性的字段)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Column &#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"><span class="comment">//name属性定义了，被标注字段在数据库表中所对应字段的名称</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">unique</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"><span class="comment">//unique属性表示该字段是否为唯一标识，默认为false。如果表中有一个字段需要唯一标识，则既可以使用该标记，也可以使用@Table标记中的@UniqueConstraint</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">nullable</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"><span class="comment">//nullable属性表示该字段是否可以为null值，默认为true</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">insertable</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"><span class="comment">//insertable属性表示在使用“INSERT”脚本插入数据时，是否需要插入该字段的值</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">updatable</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line"><span class="comment">//updatable属性表示在使用“UPDATA”脚本插入数据时，是否需要更新该字段的值。</span></span><br><span class="line">    <span class="comment">//ps:insertable和updatable属性一般多用于只读属性，例如主键和外键等。这些字段的值通常是自动生成的。</span></span><br><span class="line">    <span class="function">String <span class="title">columnDefinition</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"><span class="comment">//上面的代码注释已经写了</span></span><br><span class="line">    <span class="function">String <span class="title">table</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"><span class="comment">//table属性定义了包含当前字段的表名</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">length</span><span class="params">()</span> <span class="keyword">default</span> 255</span>;</span><br><span class="line"><span class="comment">//length属性表示字段的长度，当字段的类型为varchar时，该属性才有效，默认为255个字符</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">precision</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line"><span class="comment">//precision和scale属性表示精度，当字段类型为double时，precision表示数值的总长度，scale表示小数点所占的位数。</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">scale</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
   <div>
        
    </div>

   
    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>

  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xuemingde.com/posts/2NPWEZZ.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="meadel">
      <meta itemprop="description" content="我的愿望，世界和平">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Middle's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2NPWEZZ.html" class="post-title-link" itemprop="url">InnoDB锁专题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-06 00:00:00" itemprop="dateCreated datePublished" datetime="2022-05-06T00:00:00+08:00">2022-05-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-13 16:46:48" itemprop="dateModified" datetime="2022-08-13T16:46:48+08:00">2022-08-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a>
                </span>
            </span>

          
            <span id="/posts/2NPWEZZ.html" class="post-meta-item leancloud_visitors" data-flag-title="InnoDB锁专题" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/2NPWEZZ.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/2NPWEZZ.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>18 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文：<span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvRnd0TVdCVF9HQkgyY1Nnb2Qyb1V6QQ==">两万字详解！InnoDB锁专题！<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<p>本文将跟大家聊聊InnoDB的锁。本文比较长，包括一条SQL是如何加锁的，一些加锁规则、如何分析和解决死锁问题等内容，建议耐心读完，肯定对大家有帮助的。</p>
<ol>
<li>为什么需要加锁呢？</li>
<li>InnoDB的七种锁介绍</li>
<li>一条SQL是如何加锁的</li>
<li>RR隔离级别下的加锁规则</li>
<li>如何查看事务加锁情况</li>
<li>死锁案例分析</li>
</ol>
<h2 id="为什么需要加锁？"><a href="#为什么需要加锁？" class="headerlink" title="为什么需要加锁？"></a>为什么需要加锁？</h2><p>数据库为什么需要加锁呢？</p>
<blockquote>
<p>在日常生活中，如果你心情不好。想要一个人静静，<strong>不想被比别人打扰</strong>，你就可以把自己关进房间里，并且<strong>反锁</strong>。</p>
</blockquote>
<p>同理，对于MySQL数据库来说的话，一般的对象都是一个事务一个事务来说的。所以，如果一个事务内，正在写某个SQL，我们肯定<strong>不想它被别的事务影响</strong>到嘛？因此，数据库设计大叔，就给被操作的<strong>SQL加上锁</strong>。</p>
<blockquote>
<p>专业一点的说法: 如果有多个并发请求存取数据，在数据就可能会产生多个事务同时操作同一行数据。如果并发操作不加控制，不加锁的话，就可能写入了不正确的数据，或者导致读取了不正确的数据，破坏了数据的一致性。因此需要考虑加锁。</p>
</blockquote>
<h3 id="事务并发存在的问题"><a href="#事务并发存在的问题" class="headerlink" title="事务并发存在的问题"></a>事务并发存在的问题</h3><ul>
<li><strong>脏读</strong>:一个事务A读取到事务B未提交的数据，就是<strong>脏读</strong>。</li>
<li><strong>不可重复读</strong>：事务A被事务B干扰到了！在事务A范围内，两个相同的查询，读取同一条记录，却返回了不同的数据，这就是<strong>不可重复读</strong>。</li>
<li><strong>幻读</strong>：事务A查询一个范围的结果集，另一个并发事务B往这个范围中<strong>插入/删除</strong>了数据，并静悄悄地提交，然后事务A再次查询相同的范围，两次读取得到的结果集不一样了，这就是幻读。</li>
</ul>
<h3 id="一个加锁和不加锁对比的例子"><a href="#一个加锁和不加锁对比的例子" class="headerlink" title="一个加锁和不加锁对比的例子"></a>一个加锁和不加锁对比的例子</h3><p>我们知道MySQL数据库有四大隔离级别<strong>读已提交（RC）、可重复读（RR）、串行化、读未提交</strong>。如果是<strong>读未提交隔离</strong>级别，并发情况下，它是不加锁的，因此就会存在<strong>脏读、不可重复读、幻读</strong>的问题。</p>
<p>为了更通俗易懂一点，还是给大家举个例子吧，虽然东西挺简单的。假设现在有表结构和数据如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `account` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `balance` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `un_name_idx` (`name`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> account(id,name,balance)<span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;Jay&#x27;</span>,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> account(id,name,balance)<span class="keyword">values</span> (<span class="number">2</span>,<span class="string">&#x27;Eason&#x27;</span>,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> account(id,name,balance)<span class="keyword">values</span> (<span class="number">3</span>,<span class="string">&#x27;Lin&#x27;</span>,<span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>在<strong>READ-UNCOMMITTED（读未提交）</strong> 隔离级别下，假设现在有两个事务A、B：</p>
<ul>
<li>假设现在Jay的余额是100，事务A正在准备查询Jay的余额</li>
<li>这时候，事务B先扣减Jay的余额，扣了10</li>
<li>最后A 读到的是扣减后的余额</li>
</ul>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0840-zjCmem.png" alt=""></p>
<p>手动验证了一把，流程如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0841-9C4X0u.png" alt=""></p>
<p>由上图可以发现，事务A、B交替执行，事务A被事务B干扰到了，因为事务A读取到事务B未提交的数据,这就是脏读。为什么存在脏读问题呢？这是因为在<strong>读未提交的隔离级别</strong>下执行写操作，并<strong>没有对SQL加锁</strong>，因此产生了<strong>脏读</strong>这个问题。</p>
<p>我们再来看下，在<strong>串行化隔离级别</strong>下，同样的SQL执行流程，又是怎样的呢？</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0841-Rzo6ff.png" alt=""></p>
<p>为啥会阻塞等待超时呢？这是因为<strong>串行化隔离级别</strong>下，对写的SQL<strong>加锁</strong>啦。我们可以再看下加了什么锁，命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_status_output<span class="operator">=</span><span class="keyword">ON</span>;  开启输出</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_status_output_locks<span class="operator">=</span><span class="keyword">ON</span>;  开启锁信息输出</span><br><span class="line"><span class="keyword">SHOW</span> ENGINE INNODB STATUS</span><br></pre></td></tr></table></figure>
<p>锁相关的输出内容如下：<img data-src="https://xuemingde.com/pages/image/2022/05/06/0843-jljDOq.png" alt=""></p>
<p>我们可以看到了这么一把锁：<code>lock_mode X locks rec but not gap</code>，它到底是一种什么锁呢？来来来，我们一起来学习下<strong>InnoDB的七种锁</strong>。</p>
<h2 id="InnoDB的七种锁介绍"><a href="#InnoDB的七种锁介绍" class="headerlink" title="InnoDB的七种锁介绍"></a>InnoDB的七种锁介绍</h2><p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0844-6u96Tm.png" alt=""></p>
<h3 id="共享-排他锁"><a href="#共享-排他锁" class="headerlink" title="共享/排他锁"></a>共享/排他锁</h3><p>InnoDB呢实现了两种标准的<strong>行级锁</strong>：共享锁（简称S锁）、排他锁（简称X锁）。</p>
<ul>
<li>共享锁：简称为S锁，<strong>在事务要读取一条记录时，需要先获取该记录的S锁。</strong></li>
<li>排他锁：简称X锁，<strong>在事务需要改动一条记录时，需要先获取该记录的X锁。</strong></li>
</ul>
<p>如果事务<code>T1</code>持有行R的<code>S</code>锁，那么另一个事务<code>T2</code>请求访问这条记录时，会做如下处理：</p>
<ul>
<li>T2 请求<code>S</code>锁立即被允许，结果<code>T1和T2</code>都持有R行的<code>S</code>锁</li>
<li>T2 请求<code>X</code>锁不能被立即允许,此操作会阻塞</li>
</ul>
<p>如果<code>T1</code>持有行R的<code>X</code>锁，那么<code>T2</code>请求R的<code>X、S</code>锁都不能被立即允许，<code>T2</code>必须等待<code>T1</code>释放<code>X</code>锁才可以，因为<code>X</code>锁与任何的锁都不兼容。</p>
<p><code>S锁和X锁</code>的兼容关系如下图表格：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0844-1PNaq9.png" alt="图片"></p>
<p><code>X</code>锁和<code>S</code>锁是对于行记录来说的话，因此可以称它们为<strong>行级锁或者行锁</strong>。我们认为行锁的粒度就比较细，其实一个事务也可以在<strong>表级别下加锁</strong>，对应的，我们称之为<strong>表锁</strong>。给表加的锁，也是可以分为<code>X</code>锁和<code>S</code>锁的哈。</p>
<p>如果一个事务给表已经加了<code>S</code>锁，则：</p>
<ul>
<li>别的事务可以继续获得该表的<code>S</code>锁，也可以获得该表中某些记录的<code>S</code>锁。</li>
<li>别的事务不可以继续获得该表的<code>X</code>锁，也不可以获得该表中某些记录的<code>X</code>锁。</li>
</ul>
<p>如果一个事务给表加了<code>X</code>锁，那么</p>
<ul>
<li>别的事务不可以获得该表的<code>S</code>锁，也不可以获得该表某些记录的<code>S</code>锁。</li>
<li>别的事务不可以获得该表的<code>X</code>锁，也不可以继续获得该表某些记录的<code>X</code>锁。</li>
</ul>
<h3 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h3><p>什么是意向锁呢？意向锁是<strong>一种不与行级锁冲突的表级锁</strong>。未来的某个时刻，事务可能要加共享或者排它锁时，先提前声明一个意向。注意一下，意向锁，是一个<strong>表级别的锁哈</strong>。</p>
<p><strong>为什么需要意向锁呢？</strong> 或者换个通俗的说法，为什么要加共享锁或排他锁时的时候，需要提前声明个意向锁呢呢？</p>
<blockquote>
<p>因为InnoDB是支持表锁和行锁共存的，如果一个事务A获取到某一行的排他锁，并未提交，这时候事务B请求获取同一个表的表共享锁。因为<strong>共享锁和排他锁是互斥的</strong>，因此事务B想对这个表加共享锁时，需要保证没有其他事务持有这个表的表排他锁，同时还要保<strong>证没有其他事务持有表中任意一行的排他锁</strong>。</p>
<p>然后问题来了，你要保证没有其他事务持有表中任意一行的排他锁的话，去遍历每一行？这样显然是一个效率很差的做法。<strong>为了解决这个问题，InnoDB的设计大叔提出了意向锁。</strong></p>
</blockquote>
<p><strong>意向锁是如何解决这个问题的呢？</strong>  我们来看下</p>
<p>意向锁分为两类：</p>
<ul>
<li>意向共享锁：简称<code>IS</code>锁，当事务准备在某些记录上加S锁时，需要现在表级别加一个<code>IS</code>锁。</li>
<li>意向排他锁：简称<code>IX</code>锁，当事务准备在某条记录上加上X锁时，需要现在表级别加一个<code>IX</code>锁。</li>
</ul>
<p>比如：</p>
<ul>
<li><code>select ... lock in share mode</code>，要给表设置<code>IS</code>锁;</li>
<li><code>select ... for update</code>，要给表设置<code>IX</code>锁;</li>
</ul>
<p>意向锁又是如何解决这个效率低的问题呢：</p>
<blockquote>
<p>如果一个事务A获取到某一行的排他锁，并未提交,这时候表上就有<code>意向排他锁</code>和这一行的<code>排他锁</code>。这时候事务B想要获取这个表的共享锁，此时因为检测到事务A持有了表的<code>意向排他锁</code>，因此事务A必然持有某些行的排他锁，也就是说事务B对表的加锁请求需要阻塞等待，不再需要去检测表的每一行数据是否存在排他锁啦。这样效率就高很多啦。</p>
</blockquote>
<p>意向锁仅仅表明意向的锁，意向锁之间<strong>并不会互斥，是可以并行的</strong>，整体兼容性如下图所示：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0844-eSVbOP.png" alt=""></p>
<h3 id="记录锁（Record-Lock）"><a href="#记录锁（Record-Lock）" class="headerlink" title="记录锁（Record Lock）"></a>记录锁（Record Lock）</h3><p>记录锁是最简单的行锁，仅仅锁住一行。如：<code>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE</code>，如果c1字段是主键或者是唯一索引的话，这个SQL会加一个记录锁（Record Lock）</p>
<p>记录锁永远都是加在索引上的，即使一个表没有索引，InnoDB也会隐式的创建一个索引，并使用这个索引实施记录锁。它会阻塞其他事务对这行记录的插入、更新、删除。</p>
<p>一般我们看死锁日志时，都是找关键词，比如<code>lock_mode X locks rec but not gap</code>），就表示一个X型的记录锁。记录锁的关键词就是<strong>rec but not gap</strong>。以下就是一个记录锁的日志：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">58</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`t` </span><br><span class="line">trx id <span class="number">10078</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8000000</span>a; <span class="keyword">asc</span>     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">00000000274</span>f; <span class="keyword">asc</span>     <span class="string">&#x27;O;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex b60000019d0110; asc        ;;</span></span><br></pre></td></tr></table></figure>
<h3 id="间隙锁（Gap-Lock）"><a href="#间隙锁（Gap-Lock）" class="headerlink" title="间隙锁（Gap Lock）"></a>间隙锁（Gap Lock）</h3><p>为了解决幻读问题，InnoDB引入了间隙锁<code>(Gap Lock)</code>。间隙锁是一种加在两个索引之间的锁，或者加在第一个索引之前，或最后一个索引之后的间隙。它锁住的是<strong>一个区间</strong>，而不仅仅是这个区间中的每一条数据。</p>
<p>比如<code>lock_mode X locks gap before rec</code>表示X型gap锁。以下就是一个间隙锁的日志：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">177</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">80</span> index idx_name <span class="keyword">of</span> <span class="keyword">table</span> `test2`.`account` </span><br><span class="line">trx id <span class="number">38049</span> lock_mode X locks gap before rec</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">6</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">3</span>; hex <span class="number">576569</span>; <span class="keyword">asc</span> Wei;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">4</span>; hex <span class="number">80000002</span>; <span class="keyword">asc</span>     ;;</span><br></pre></td></tr></table></figure>
<h3 id="临键锁-Next-Key-Lock"><a href="#临键锁-Next-Key-Lock" class="headerlink" title="临键锁(Next-Key Lock)"></a>临键锁(Next-Key Lock)</h3><p>Next-key锁是<strong>记录锁和间隙锁的组合</strong>，它指的是加在某条记录以及这条记录前面间隙上的锁。说得更具体一点就是:临键锁会封锁索引记录本身，以及索引记录之前的区间，即它的锁区间是前开后闭，比如<code>(5,10]</code>。</p>
<p>如果一个会话占有了索引记录R的共享/排他锁，其他会话不能立刻在R之前的区间插入新的索引记录。官网是这么描述的：</p>
<blockquote>
<p>If one session has a shared or exclusive lock on record R in an index,  another session cannot insert a new index record in the gap immediately  before R in the index order.</p>
</blockquote>
<h3 id="插入意向锁"><a href="#插入意向锁" class="headerlink" title="插入意向锁"></a>插入意向锁</h3><p>插入意向锁,是插入一行记录操作之前设置的<strong>一种间隙锁。</strong>这个锁释放了一种插入方式的信号。它解决的问题是：多个事务，在同一个索引，同一个范围区间插入记录时，如果插入的位置不冲突，就不会阻塞彼此。</p>
<p>假设有索引值4、7，几个不同的事务准备插入5、6，每个锁都在获得插入行的独占锁之前用插入意向锁各自锁住了4、7之间的间隙，但是不阻塞对方因为插入行不冲突。以下就是一个插入意向锁的日志：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RECORD</span> LOCKS space id <span class="number">31</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> <span class="keyword">index</span> `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`child`</span><br><span class="line">trx id <span class="number">8731</span> lock_mode X locks gap <span class="keyword">before</span> rec <span class="keyword">insert</span> intention waiting</span><br><span class="line"><span class="type">Record</span> <span class="keyword">lock</span>, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL <span class="type">RECORD</span>: n_fields <span class="number">3</span>; compact <span class="keyword">format</span>; <span class="keyword">info</span> bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">80000066</span>; <span class="keyword">asc</span>    f;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000002215</span>; <span class="keyword">asc</span>     &quot; ;;</span><br><span class="line"> 2: len 7; hex 9000000172011c; asc     r  ;;...</span><br></pre></td></tr></table></figure>
<p>锁模式兼容矩阵（横向是已持有锁，纵向是正在请求的锁）如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0845-cIOfdv.png" alt=""></p>
<h3 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h3><p><strong>自增锁是一种特殊的表级别锁</strong>。它是专门针对<code>AUTO_INCREMENT</code>类型的列，对于这种列，如果表中新增数据时就会去持有自增锁。简言之，如果一个事务正在往表中插入记录，所有其他事务的插入必须等待，以便第一个事务插入的行，是连续的主键值。</p>
<p>官方文档是这么描述的：</p>
<blockquote>
<p>An AUTO-INC lock is a special table-level lock taken by transactions  inserting into tables with AUTO_INCREMENT columns. In the simplest case, if one transaction is inserting values into the table, any other  transactions must wait to do their own inserts into that table, so that  rows inserted by the first transaction receive consecutive primary key  values.</p>
</blockquote>
<p>假设有表结构以及自增模式是1，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> t0 (id <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,name <span class="type">varchar</span>(<span class="number">16</span>),<span class="keyword">primary</span> key ( id));</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%innodb_autoinc_lock_mode%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="operator">|</span> innodb_autoinc_lock_mode <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>设置事务A和B交替执行流程如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0846-PQAgHX.png" alt=""></p>
<p>通过上图我们可以看到，当我们在事务A中进行自增列的插入操作时，另外会话事务B也进行插入操作，这种情况下会发生2个奇怪的现象：</p>
<ul>
<li>事务A会话中的自增列好像直接增加了2个值。（如上图中步骤7、8）</li>
<li>事务B会话中的自增列直接从2开始增加的。（如上图步骤5、6）</li>
</ul>
<p>自增锁是一个表级别锁，那为什么会话A事务还没结束，事务会话B可以执行插入成功呢？不是应该锁表嘛？</p>
<p>这是因为在参数<code>innodb_autoinc_lock_mode</code>上，这个参数设置为<code>1</code>的时候，相当于将这种<code>auto_inc lock</code>弱化为了一个更轻量级的互斥自增长机制去实现，官方称之为<code>mutex</code>。</p>
<p><code>innodb_autoinc_lock_mode</code>还可以设置为0或者2，</p>
<ul>
<li><strong>0</strong>：表示传统锁模式，使用<code>表级AUTO_INC</code>锁。一个事务的<code>INSERT-LIKE</code>语句在语句执行结束后释放AUTO_INC表级锁，而不是在事务结束后释放。</li>
<li><strong>1</strong>: 连续锁模式,连续锁模式对于<code>Simple inserts</code>不会使用表级锁，而是使用一个轻量级锁来生成自增值，因为InnoDB可以提前直到插入多少行数据。自增值生成阶段使用轻量级互斥锁来生成所有的值，而不是一直加锁直到插入完成。对于<code>bulk inserts</code>类语句使用AUTO_INC表级锁直到语句完成。</li>
<li><strong>2</strong>:交错锁模式,所有的<code>INSERT-LIKE</code>语句都不使用表级锁，而是使用轻量级互斥锁。</li>
</ul>
<blockquote>
<ul>
<li><strong>INSERT-LIKE</strong>:指所有的插入语句，包括：INSERT、REPLACE、INSERT…SELECT、REPLACE…SELECT,LOAD DATA等。</li>
<li><strong>Simple inserts</strong>:指在插入前就能确定插入行数的语句，包括：INSERT、REPLACE，不包含INSERT…ON DUPLICATE KEY UPDATE这类语句。</li>
<li><strong>Bulk inserts</strong>: 指在插入钱不能确定行数的语句，包括：INSERT … SELECT/REPLACE … SELECT/LOAD DATA。</li>
</ul>
</blockquote>
<h2 id="一条SQL是如何加锁的呢？"><a href="#一条SQL是如何加锁的呢？" class="headerlink" title="一条SQL是如何加锁的呢？"></a>一条SQL是如何加锁的呢？</h2><p>介绍完InnoDB的七种锁后，我们来看下一条SQL是如何加锁的哈，现在可以分9种情况进行：</p>
<ul>
<li>组合一：查询条件是主键，RC隔离级别</li>
<li>组合二：查询条件是唯一索引，RC隔离级别</li>
<li>组合三：查询条件是普通索引，RC隔离级别</li>
<li>组合四：查询条件上没有索引，RC隔离级别</li>
<li>组合五：查询条件是主键，RR隔离级别</li>
<li>组合六：查询条件是唯一索引，RR隔离级别</li>
<li>组合七：查询条件是普通索引，RR隔离级别</li>
<li>组合八：查询条件上没有索引，RR隔离级别</li>
<li>组合九：Serializable隔离级别</li>
</ul>
<h3 id="查询条件是主键-RC隔离级别"><a href="#查询条件是主键-RC隔离级别" class="headerlink" title="查询条件是主键 + RC隔离级别"></a>查询条件是主键 + RC隔离级别</h3><p>在<strong>RC（读已提交）</strong> 的隔离级别下，对查询条件列是主键id的话，会加什么锁呢？</p>
<p>我们搞个简单的表，初始化几条数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (id <span class="type">int</span>,name <span class="type">varchar</span>(<span class="number">16</span>),<span class="keyword">primary</span> key ( id));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;c&#x27;</span>),(<span class="number">6</span>,<span class="string">&#x27;b&#x27;</span>),(<span class="number">9</span>,<span class="string">&#x27;a&#x27;</span>),(<span class="number">10</span>,<span class="string">&#x27;d&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>假设给定SQL：<code>delete from t1 where id = 6;</code>，id是主键。在RC隔离级别下，只需要将主键上<code>id = 6</code>的记录，加上<code>X锁</code>即可。</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-KXzs9k.png" alt=""></p>
<p>我们来验证一下吧，先开启事务会话A，先执行以下操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>删除id<span class="operator">=</span><span class="number">6</span>的这条记录</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>接着开启事务会话B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">update t1 <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;b1&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span><span class="number">6</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>发现这个阻塞等待，最后超时释放锁了</span><br></pre></td></tr></table></figure>
<p>验证流程图如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-kG1emh.png" alt=""></p>
<p>事务会话B对<code>id=6</code>的记录执行更新时，发现阻塞了，打开看下加了什么锁。发现是因为<code>id=6</code>这一行加了一个X型的记录锁</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0848-tcfUmz.png" alt=""></p>
<p>如果我们事务B不是对<code>id=6</code>执行更新，而是其他记录的话，是可以顺利执行的，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0848-iVSpw0.png" alt=""></p>
<p><strong>结论就是</strong>，在<strong>RC（读已提交）</strong> 的隔离级别下，对查询条件是主键id的场景，会加一个排他锁（X锁），或者说加一个X型的记录锁。</p>
<h3 id="查询条件是唯一索引-RC隔离级别"><a href="#查询条件是唯一索引-RC隔离级别" class="headerlink" title="查询条件是唯一索引+RC隔离级别"></a>查询条件是唯一索引+RC隔离级别</h3><p>如果查询条件id，只是一个唯一索引呢？那在RC（读提交隔离级别下），又加了什么锁呢？我们搞个新的表，初始化几条数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 (name <span class="type">varchar</span>(<span class="number">16</span>),id <span class="type">int</span>,<span class="keyword">primary</span> key (name),<span class="keyword">unique</span> key(id));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">values</span>(<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>),(<span class="string">&#x27;c&#x27;</span>,<span class="number">3</span>),(<span class="string">&#x27;b&#x27;</span>,<span class="number">6</span>),(<span class="string">&#x27;d&#x27;</span>,<span class="number">9</span>);</span><br></pre></td></tr></table></figure>
<p>id是唯一索引，name是主键的场景下，我们给定SQL：<code>delete from t2 where id = 6;</code>。</p>
<p>在RC隔离级别下，该SQL需要加两个<code>X</code>锁，一个对应于id 唯一索引上的<code>id = 6</code>的记录，另一把锁对应于聚簇索引上的<code>[name=’b’,id=6]</code>的记录。</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0848-ZWno4R.png" alt=""></p>
<p><strong>为什么主键索引上的记录也要加锁呢？</strong></p>
<blockquote>
<p>如果并发的一个SQL，是通过主键索引来更新：<code>update t2 set id = 666 where name = &#39;b&#39;;</code>此时，如果delete语句没有将主键索引上的记录加锁，那么并发的update就会感知不到delete语句的存在，违背了同一记录上的更新/删除需要串行执行的约束。</p>
</blockquote>
<h3 id="查询条件是普通索引-RC隔离级别"><a href="#查询条件是普通索引-RC隔离级别" class="headerlink" title="查询条件是普通索引 + RC隔离级别"></a>查询条件是普通索引 + RC隔离级别</h3><p>如果查询条件是普通的二级索引，在RC（读提交隔离级别下），又加了什么锁呢？</p>
<blockquote>
<p>若id列是普通索引，那么对应的所有满足SQL查询条件的记录，都会加上锁。同时，这些记录对应主键索引，也会上锁。</p>
</blockquote>
<p>我们初始化下表结构和数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t3 (name <span class="type">varchar</span>(<span class="number">16</span>),id <span class="type">int</span>,<span class="keyword">primary</span> key (name),key(id));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t3 <span class="keyword">values</span>(<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>),(<span class="string">&#x27;c&#x27;</span>,<span class="number">3</span>),(<span class="string">&#x27;b&#x27;</span>,<span class="number">6</span>),(<span class="string">&#x27;e&#x27;</span>,<span class="number">6</span>),(<span class="string">&#x27;d&#x27;</span>,<span class="number">9</span>);</span><br></pre></td></tr></table></figure>
<p>加锁示意图如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0848-2QRBai.png" alt=""></p>
<p>我们来验证一下，先开启事务会话A，先执行以下操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>删除id<span class="operator">=</span><span class="number">6</span>的这条记录</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t3 <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>接着开启事务会话B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">update t3 <span class="keyword">set</span> id<span class="operator">=</span><span class="number">7</span> <span class="keyword">where</span> name <span class="operator">=</span><span class="string">&#x27;e&#x27;</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>发现这个阻塞等待，最后超时释放锁了</span><br></pre></td></tr></table></figure>
<p>实践流程如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-MVh31G.png" alt=""></p>
<p>事务会话B为什么会阻塞等待超时，是因为事务会话A的<code>delete语句</code>确实有加<strong>主键索引的X锁</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0850-5TmKEB.png" alt=""></p>
<h3 id="查询条件列无索引-RC隔离级别"><a href="#查询条件列无索引-RC隔离级别" class="headerlink" title="查询条件列无索引+RC隔离级别"></a>查询条件列无索引+RC隔离级别</h3><p>如果id没有加索引，只是一个常规的列，在RC（读提交隔离级别下），又加了什么锁呢？</p>
<blockquote>
<p>若id列上没有索引，MySQL会走聚簇索引进行全表扫描过滤。每条记录都会加上X锁。但是，<strong>为了效率考虑，MySQL在这方面进行了改进</strong>，在扫描过程中，<strong>若记录不满足过滤条件，会进行解锁操作</strong>。同时优化违背了2PL原则。</p>
</blockquote>
<p>初始化下表结构和数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t4 (name <span class="type">varchar</span>(<span class="number">16</span>),id <span class="type">int</span>,<span class="keyword">primary</span> key (name));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t4 <span class="keyword">values</span>(<span class="string">&#x27;a&#x27;</span>,<span class="number">1</span>),(<span class="string">&#x27;c&#x27;</span>,<span class="number">3</span>),(<span class="string">&#x27;b&#x27;</span>,<span class="number">6</span>),(<span class="string">&#x27;e&#x27;</span>,<span class="number">6</span>),(<span class="string">&#x27;d&#x27;</span>,<span class="number">9</span>);</span><br></pre></td></tr></table></figure>
<p>加锁示意图图下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0850-XHe3A7.png" alt=""></p>
<p>验证流程如下，先开启事务会话A，先执行以下操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>删除id<span class="operator">=</span><span class="number">6</span>的这条记录</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t4 <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>接着开启事务会话B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>可以执行，MySQL因为效率问题，解锁了</span><br><span class="line">update t4 <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;f&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>阻塞等待</span><br><span class="line">update t4 <span class="keyword">set</span> name<span class="operator">=</span><span class="string">&#x27;f&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p>验证结果如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0850-CdXVfD.png" alt=""></p>
<h3 id="查询条件是主键-RR隔离级别"><a href="#查询条件是主键-RR隔离级别" class="headerlink" title="查询条件是主键+RR隔离级别"></a>查询条件是主键+RR隔离级别</h3><p>给定SQL：<code>delete from t1 where id = 6;</code>，如果id是<strong>主键</strong>的话，在RR隔离级别下，跟RC隔离级别，加锁是一样的，也都是在<code>id = 6</code>这条记录上加上<code>X</code>锁。大家感兴趣可以照着3.1小节例子，自己验证一下哈。</p>
<h3 id="查询条件是唯一索引-RR隔离级别"><a href="#查询条件是唯一索引-RR隔离级别" class="headerlink" title="查询条件是唯一索引+RR隔离级别"></a>查询条件是唯一索引+RR隔离级别</h3><p>给定SQL：<code>delete from t1 where id = 6;</code>，如果id是<strong>唯一索引</strong>的话，在RR隔离级别下，跟RC隔离级别，加锁也是一样的哈，加了两个<code>X</code>锁，id唯一索引满足条件的记录上一个，对应的主键索引上的记录一个。</p>
<h3 id="查询条件是普通索引-RR隔离级别"><a href="#查询条件是普通索引-RR隔离级别" class="headerlink" title="查询条件是普通索引+RR隔离级别"></a>查询条件是普通索引+RR隔离级别</h3><p>如果查询条件是普通的二级索引，在RR（可重复读的隔离级别下），除了会加<code>X</code>锁，<strong>还会加<code>间隙Gap</code>锁</strong>。Gap锁的提出，是为了解决幻读问题引入的，它是一种加在两个索引之间的锁。</p>
<p>假设有表结构和初始化数据如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t5 ( id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, c <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, d <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, <span class="keyword">PRIMARY</span> KEY (id), KEY c (c)) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t5 <span class="keyword">values</span>(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure>
<p>如果一条更新语句<code>update t5 set d=d+1 where c = 10</code>，加锁示意图如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0902-qfPKDu.png" alt=""></p>
<p>我们来验证一下吧，先开启事务会话A，先执行以下操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">update t5 <span class="keyword">set</span> d<span class="operator">=</span>d<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> c <span class="operator">=</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>接着开启事务会话B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t5 <span class="keyword">values</span>(<span class="number">12</span>,<span class="number">12</span>,<span class="number">12</span>);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>阻塞等待，最后超时释放锁了</span><br></pre></td></tr></table></figure>
<p>验证流程图如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0902-39Kfd7.png" alt=""></p>
<p>为什么会阻塞呢？因此<code>c=10</code>这个记录更新时，不仅会有两把<code>X</code>锁，还会把区间<code>（10,15）</code>加间隙锁，因此要插入<code>（12,12,12）</code>记录时，会阻塞。</p>
<h3 id="查询条件列无索引-RR隔离级别"><a href="#查询条件列无索引-RR隔离级别" class="headerlink" title="查询条件列无索引+RR隔离级别"></a>查询条件列无索引+RR隔离级别</h3><p>如果查询条件列没有索引呢？又是如何加的锁呢？</p>
<p>假设有表结构和数据如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t5 ( id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, c <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, d <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, <span class="keyword">PRIMARY</span> KEY (id)) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t5 <span class="keyword">values</span>(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure>
<p>给定一条更新语句<code>update t5 set d=d+1 where c = 10</code>，因为<code>c</code>列没有索引，加锁示意图如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0902-WeELho.png" alt=""></p>
<p>如果查询条件列没有索引，主键索引的所有记录，都将加上<code>X锁</code>，每条记录间也都加上<code>间隙Gap锁</code>。大家可以想象一下，任何加锁并发的SQL，都是不能执行的，全表都是锁死的状态。如果表的数据量大，那效率就更低。</p>
<blockquote>
<p>在这种情况下，MySQL做了一些优化，即<code>semi-consistent read</code>，对于不满足条件的记录，MySQL提前释放锁，同时Gap锁也会释放。而<code>semi-consistent read</code>是如何触发的呢：要么在<code>Read Committed</code>隔离级别下；要么在<code>Repeatable Read</code>隔离级别下，设置了<code>innodb_locks_unsafe_for_binlog</code>参数。但是<code>semi-consistent read</code>本身也会带来其他的问题，不建议使用。</p>
</blockquote>
<p>我们来验证一下哈，先开启事务会话A，先执行以下操作：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">update t5 <span class="keyword">set</span> d<span class="operator">=</span>d<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> c <span class="operator">=</span> <span class="number">20</span>;</span><br></pre></td></tr></table></figure>
<p>接着开启事务会话B</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t5 <span class="keyword">values</span>(<span class="number">16</span>,<span class="number">16</span>,<span class="number">16</span>);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>插入阻塞等待</span><br><span class="line">update t5 <span class="keyword">set</span> d<span class="operator">=</span>d<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> c <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>更新阻塞等待</span><br></pre></td></tr></table></figure>
<p>我们去更新一条不存在的<code>c=16</code>的记录，也会被X锁阻塞的。验证如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0902-9Yheuk.png" alt=""></p>
<h3 id="Serializable串行化"><a href="#Serializable串行化" class="headerlink" title="Serializable串行化"></a>Serializable串行化</h3><p>在<strong>Serializable串行化的隔离级别</strong>下，对于写的语句，比如<code>update account set balance= balance-10 where name=‘Jay’;</code>，跟RC和RR隔离级别是一样的。不一样的地方是，在查询语句，如<code>select balance from account where name = ‘Jay’;</code>，在<strong>RC和RR</strong>是不会加锁的，但是在Serializable串行化的隔离级别，即会加锁。</p>
<p>如文章开始第一小节的那个例子，就是类似的：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0903-hHscAN.png" alt=""></p>
<h2 id="RR隔离级别下，加锁规则到底是怎样的呢？"><a href="#RR隔离级别下，加锁规则到底是怎样的呢？" class="headerlink" title="RR隔离级别下，加锁规则到底是怎样的呢？"></a>RR隔离级别下，加锁规则到底是怎样的呢？</h2><p>对于RC隔离级别，加的排他锁（X锁），是比较好理解的，哪里更新就锁哪里嘛。但是<strong>RR隔离级别</strong>，间隙锁是怎么加的呢？我们一起来学习一下。</p>
<p>对<strong>InnoDb</strong>的锁来说，面试的时候问的比较多，就是<code>Record lock、Gap lock、Next-key lock</code>。接下来我们来学习，RR隔离级别，到底一个锁是怎么加上去的。<strong>丁奇的MySQL45讲有讲到，RR隔离级别，是如何加锁的。大家有兴趣可以去订购看下哈，非常不错的课程。</strong></p>
<p>首先MySQL的版本，是<code>5.x 系列 &lt;=5.7.24，8.0 系列 &lt;=8.0.13</code>。加锁规则一共包括：两个<code>原则</code>、<code>两个优化</code>和一个<code>bug</code>。</p>
<ul>
<li><strong>原则1</strong>：加锁的基本单位都是<code>next-key lock</code>。<code>next-key lock（临键锁）</code>是前开后闭区间。</li>
<li><strong>原则2</strong>：查找过程中访问到的对象才会加锁。</li>
<li><strong>优化1</strong>：索引上的等值查询，给唯一索引加锁的时候，<code>next-key lock</code>退化为行锁<code>（Record lock）</code>。</li>
<li><strong>优化 2</strong>：索引上的等值查询，向右遍历时且最后一个值不满足等值条件的时候，<code>next-key lock</code>退化为间隙锁（Gap lock）。</li>
<li><strong>一个 bug</strong>：唯一索引上的范围查询会访问到不满足条件的第一个值为止。</li>
</ul>
<p>假设有表结构和数据如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t5 ( id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, c <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, d <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, <span class="keyword">PRIMARY</span> KEY (id), KEY c (c)) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t5 <span class="keyword">values</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>),(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>),(<span class="number">15</span>,<span class="number">15</span>,<span class="number">15</span>),(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>),(<span class="number">25</span>,<span class="number">25</span>,<span class="number">25</span>);</span><br></pre></td></tr></table></figure>
<p>分7个案例去分析哈：</p>
<ol>
<li>等值查询间隙锁</li>
<li>非唯一索引等值锁</li>
<li>主键索引范围锁</li>
<li>非唯一索引范围锁</li>
<li>唯一索引范围锁 bug</li>
<li>普通索引上存在”等值”的例子</li>
<li>limit 语句减少加锁范围</li>
</ol>
<h3 id="案例一：等值查询间隙锁"><a href="#案例一：等值查询间隙锁" class="headerlink" title="案例一：等值查询间隙锁"></a>案例一：等值查询间隙锁</h3><p>我们同时开启A、B、C三个会话事务，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0903-I4wc17.png" alt=""></p>
<p>发现事务B会阻塞等待，而C可以执行成功。如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0903-ciVgJv.png" alt=""></p>
<p><strong>为什么事务B会阻塞呢？</strong></p>
<ul>
<li>这是因为根据<strong>加锁原则1</strong>：加锁基本单位是<code>next-key lock</code>，因此事务会话 A的加锁范围是（5,10]，这里为什么是区间（5,10]，这是因为更新的记录，所在的表已有数据的区间就是5-10哈，又因为<code>next-key lock</code>是左开右闭的，所以加锁范围是<code>（5,10]</code>。</li>
<li>同时<strong>根据优化 2</strong>，这是一个等值查询 (id=6)，而id=10不满足查询条件。所以<code>next-key lock</code>退化成间隙<code>Gap锁</code>，因此最终加锁的范围是<code>(5,10)</code>。</li>
<li>然后<code>事务Session B</code>中，你要插入的是9,9在区间(5,10)内，而区间(5,10)都被锁了。因此事务B会阻塞等到。</li>
</ul>
<p><strong>为什么事务C可以正常执行呢？</strong></p>
<p>这是因为锁住的区间是<code>(5,10)</code>，没有包括10，<strong>所以事务C可以正常执行</strong>。</p>
<h3 id="案例二：非唯一索引等值锁"><a href="#案例二：非唯一索引等值锁" class="headerlink" title="案例二：非唯一索引等值锁"></a>案例二：非唯一索引等值锁</h3><p>按顺序执行事务会话A、B、C，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0903-K9ZEdt.png" alt=""></p>
<p>发现事务B可以执行成功，而C阻塞等待。如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0904-qKvDbd.png" alt=""></p>
<p><strong>为什么事务会话B没有阻塞，事务会话C却阻塞了？</strong></p>
<p>事务会话A执行时，会给索引树<code>c=5</code>的这一行加上读<code>共享</code>锁。</p>
<ol>
<li>根据<strong>加锁原则1</strong>，加锁单位是<code>next-key lock</code>，因此会加上<code>next-key lock(0,5]</code>。</li>
<li>因为c 只是普通索引，所以仅访问<code>c=5</code>这一条记录时不会马上停下来，需要继续向右遍历，查到<code>c=10</code>才结束。根据<strong>加锁原则2</strong>，访问到的都要加锁，因此要给<code>(5,10]</code>加<code>next-key lock</code>。</li>
<li>由<strong>加锁优化2</strong>：等值判断，向右遍历，最后一个值10<code>不满足c=5</code> 这个等值条件，因此退化成间隙锁 <code>(5,10)</code>。</li>
<li>根据<strong>加锁原则 2</strong> ：<strong>只有访问到的对象才会加锁</strong>，事务A的这个查询使用了<strong>覆盖索引</strong>，没有回表，并不需要访问主键索引，因此主键索引上没有加任何锁，事务会话B是对主键id的更新，因此事务会话B的<code>update</code>语句不会阻塞。</li>
<li>但是事务会话C，要插入一个（6,6,6) 的记录时，会被事务会话A的<code>间隙锁(5,10)</code>锁住，因此事务会话C阻塞了。</li>
</ol>
<h3 id="案例三：主键索引范围锁"><a href="#案例三：主键索引范围锁" class="headerlink" title="案例三：主键索引范围锁"></a>案例三：主键索引范围锁</h3><p>主键范围查询又是怎么加锁的呢？比如给定SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t5 <span class="keyword">where</span> id<span class="operator">&gt;=</span><span class="number">10</span> <span class="keyword">and</span> id<span class="operator">&lt;</span><span class="number">11</span> <span class="keyword">for</span> update;</span><br></pre></td></tr></table></figure>
<p>按顺序执行事务会话A、B、C，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0905-6KeA3e.png" alt=""></p>
<p>执行结果如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0904-he5Pzo.png" alt=""></p>
<p>发现事务会话B中，插入12，即<code>insert into t5 values(12,12,12);</code>时，阻塞了，而插入6，<code>insert into t5 values(6,6,6);</code>却可以顺利执行。同时事务C中，<code>Update t5 set d=d+1 where id =15;</code>也会阻塞，为什么呢？</p>
<p>事务会话A执行时，要找到第一个<code>id=10</code>的行：</p>
<ul>
<li>根据<strong>加锁原则1</strong>：加锁单位是<code>next-key lock</code>，因此会加上<code>next-key lock(5,10]</code>。</li>
<li>又因为id是主键，也就是唯一值，因此根据<strong>优化1</strong>：索引上的等值查询，给唯一索引加锁时，<code>next-key lock</code>退化为<code>行锁（Record lock）</code>。所以只加了<code>id=10</code>这个行锁。</li>
<li>范围查找就往后继续找，找到<code>id=15</code>这一行停下来，因此还需要加<code>next-key lock(10,15]</code>。</li>
</ul>
<p>事务会话A执行完后，加的锁是<code>id=10</code>这个行锁，以及临键锁<code>next-key lock(10,15]</code>。这就是为什么事务B插入6那个记录可以顺利执行，插入12就不行啦。同理，事务C那个更新id=15的记录，也是会被阻塞的。</p>
<h3 id="案例四：非唯一索引范围锁"><a href="#案例四：非唯一索引范围锁" class="headerlink" title="案例四：非唯一索引范围锁"></a>案例四：非唯一索引范围锁</h3><p>如果是普通索引，范围查询又加什么锁呢？按顺序执行事务会话A、B、C，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-q6kmuK.png" alt=""></p>
<p>执行结果如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0905-uPcab7.png" alt=""></p>
<p>发现事务会话B和事务会话C的执行SQL都被阻塞了。</p>
<p>这是因为，事务会话A执行时，要找到第一个<code>c=10</code>的行：</p>
<ol>
<li>根据加锁原则1：加锁单位是next-key lock，因此会加上<code>next-key lock(5,10]</code>。又因为c不是唯一索引，所以它不会退化为行锁。因此加的锁还是<code>next-key lock(5,10]</code>。</li>
<li>范围查找就往后继续找，找到<code>id=15</code>这一行停下来，因此还需要加<code>next-key lock(10,15]</code>。</li>
</ol>
<p>因此事务B和事务C插入的<code>insert into t5 values(6,6,6);</code>和<code>Update t5 set d=d+1 where c =15;</code> 都会阻塞。</p>
<h3 id="案例五：唯一索引范围锁-bug"><a href="#案例五：唯一索引范围锁-bug" class="headerlink" title="案例五：唯一索引范围锁 bug"></a>案例五：唯一索引范围锁 bug</h3><p>前面四种方案中，加锁的两个原则和两个优化都已经用上啦，那个唯一索引范围bug是如何触发的呢？</p>
<p>按顺序执行事务会话A、B、C，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0905-caM9Bu.png" alt=""></p>
<p>执行结果如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0905-ARS7ah.png" alt=""></p>
<p>发现事务B的更新语句<code>Update t5 set d=d+1 where id =20;</code>和事务C<code>insert into t5 values(18,18,18);</code>的插入语句均已阻塞了。</p>
<p>这是因为，事务会话A执行时，要找到第一个<code>id=15</code>的行，根据加锁原则1：加锁单位是<code>next-key lock</code>，因此会加上<code>next-key lock(10,15]</code>。因为id是主键，即唯一的，因此循环判断到 id=15 这一行就应该停止了。但是实现上，InnoDB 会往前扫描到第一个不满足条件的行为止，直到扫描到<code>id=20</code>。而且由于这是个范围扫描，因此索引id上的<code>(15,20]</code>这个 next-key lock 也会被锁上。</p>
<p>所以，事务B要更新 id=20 这一行时，会阻塞锁住。同样地事务会话C要插入<code>id=16</code>的一行，也会被锁住。</p>
<h3 id="案例六：普通索引上存在”等值”的例子"><a href="#案例六：普通索引上存在”等值”的例子" class="headerlink" title="案例六：普通索引上存在”等值”的例子"></a>案例六：普通索引上存在”等值”的例子</h3><p>如果查询条件列是普通索引，且存在相等的值，加锁又是怎样的呢？</p>
<p>在原来t5表的数据基础上，插入：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t5 <span class="keyword">values</span>(<span class="number">28</span>,<span class="number">10</span>,<span class="number">66</span>);</span><br></pre></td></tr></table></figure>
<p>则<code>c索引</code>树如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0906-TmNMbH.png" alt=""></p>
<p>c索引值有相等的，但是它们对应的主键是有间隙的。比如<code>（c=10，id=10）和（c=10，id=28）</code>之间。</p>
<p>我们来看个例子，按顺序执行事务会话A、B、C，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0906-56dH1p.png" alt=""></p>
<p>执行结果如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0906-qHyOtb.png" alt=""></p>
<p>为什么事务B插入语句会阻塞，事务C的更新语句不会呢？</p>
<ul>
<li>这是因为事务会话A在遍历的时候，先访问第一个<code>c=10</code>的记录。它根据<strong>原则 1</strong>，加一个(c=5,id=5) 到 (c=10,id=10)的next-key lock。</li>
<li>然后，事务会话A向右查找，直到碰到 (c=15,id=15) 这一行，循环才结束。根据优化 2，这是一个等值查询，向右查找到了不满足条件的行，所以会退化成<code>(c=10,id=10) 到 (c=15,id=15)</code>的间隙Gap锁。即事务会话A这个<code>select...for update</code>语句在索引 c 上的加锁范围，就是下图灰色阴影部分的：</li>
</ul>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0906-iQzyAT.png" alt=""></p>
<p>因为c=13是这个区间内的，所以事务B插入<code>insert into t5 values(13,13,13);</code>会阻塞。因为根据优化2，已经退化成 (c=10,id=10) 到 (c=15,id=15) 的间隙Gap锁,即不包括c=15，所以事务C，<code>Update t5 set d=d+1 where c=15</code>不会阻塞</p>
<h3 id="案例七：limit-语句减少加锁范围"><a href="#案例七：limit-语句减少加锁范围" class="headerlink" title="案例七：limit 语句减少加锁范围"></a>案例七：limit 语句减少加锁范围</h3><p>如果一个SQL有limit，会不会对加锁有什么影响呢？我们用4.6的例子，然后给查询语句加个limit：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">from</span> t5 <span class="keyword">where</span> c<span class="operator">=</span><span class="number">10</span> limit <span class="number">2</span> <span class="keyword">for</span> update;</span><br></pre></td></tr></table></figure>
<p>事务A、B执行如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0906-e5VvVv.png" alt=""></p>
<p>发现事务B并没有阻塞，而是可以顺利执行</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0907-lvIaxm.png" alt=""></p>
<p>这是为什么呢？跟上个例子，怎么事务会话B的SQL却不会阻塞了，事务会话A的<code>select</code>只是加多了一个<code>limit 2</code>。</p>
<p>这是因为明确加了<code>limit 2</code>的限制后，因此在遍历到 (c=10, id=30) 这一行之后，满足条件的语句已经有两条，循环就结束了。因此，索引 c上的加锁范围就变成了从（c=5,id=5) 到（c=10,id=30) 这个前开后闭区间，如下图所示：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0907-KZVQB0.png" alt=""></p>
<p>索引平时我们写SQL的时候，比如<code>查询select或者delete语句</code>时，尽量加一下<code>limit</code>哈，你看着这个例子不就减少了锁范围了嘛，哈哈。</p>
<h2 id="如何查看事务加锁情况"><a href="#如何查看事务加锁情况" class="headerlink" title="如何查看事务加锁情况"></a>如何查看事务加锁情况</h2><p>我门怎么查看执行中的SQL加了什么锁呢？或者换个说法，如何查看事务的加锁情况呢？有这两种方法：</p>
<ul>
<li>使用<code>infomation_schema</code>数据库中的表获取锁信息</li>
<li>使用show engine innodb status 命令</li>
</ul>
<h3 id="使用infomation-schema数据库中的表获取锁信息"><a href="#使用infomation-schema数据库中的表获取锁信息" class="headerlink" title="使用infomation_schema数据库中的表获取锁信息"></a>使用infomation_schema数据库中的表获取锁信息</h3><p><code>infomation_schema</code>数据库中，有几个表跟锁紧密关联的。</p>
<ul>
<li><strong>INNODB_TRX</strong>：该表存储了InnoDB当前正在执行的事务信息，包括事务id、事务状态（比如事务是在运行还是在等待获取某个所）等。</li>
<li><strong>INNODB_LOCKS</strong>：该表记录了一些锁信息，包括两个方面：1.如果一个事务想要获取某个锁，但未获取到，则记录该锁信息。2. 如果一个事务获取到了某个锁，但是这个锁阻塞了别的事务，则记录该锁信息。</li>
<li><strong>INNODB_LOCK_WAITS</strong>:表明每个阻塞的事务是因为获取不到哪个事务持有的锁而阻塞。</li>
</ul>
<h4 id="INNODB-TRX"><a href="#INNODB-TRX" class="headerlink" title="INNODB_TRX"></a>INNODB_TRX</h4><p>我们在一个会话中执行加锁的语句，在另外一个会话窗口，即可查看<code>INNODB_TRX</code>的信息啦，如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-Zgg6SA.png" alt=""></p>
<p>表中可以看到一个事务id为<code>1644837</code>正在运行汇中，它的隔离级别为<code>REPEATABLE READ</code>。我们一般关注这几个参数：</p>
<ul>
<li>trx_tables_locked：该事务当前加了多少个表级锁。</li>
<li>trx_rows_locked：表示当前加了多少个行级锁。</li>
<li>trx_lock_structs：表示该事务生成了多少个内存中的锁结构。</li>
</ul>
<h4 id="INNODB-LOCKS"><a href="#INNODB-LOCKS" class="headerlink" title="INNODB_LOCKS"></a>INNODB_LOCKS</h4><p>一般系统中，发生某个事务<strong>因为获取不到锁而被阻塞时</strong>，该表才会有记录。</p>
<p>事务A、B执行如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0909-NTEzcV.png" alt=""></p>
<p>使用<code>select * from information_schema.INNODB_LOCKS;</code>查看</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0909-lWBKAm.png" alt=""></p>
<p>可以看到两个事务Id <code>1644842</code>和<code>1644843</code>都持有什么锁，就是看那个<code>lock_mode和lock_type</code>哈。但是并看不出是哪个锁在等待那个锁导致的阻塞，这时候就可以看<code>INNODB_LOCK_WAITS</code>表啦。</p>
<h4 id="INNODB-LOCK-WAITS"><a href="#INNODB-LOCK-WAITS" class="headerlink" title="INNODB_LOCK_WAITS"></a>INNODB_LOCK_WAITS</h4><p>INNODB_LOCK_WAITS 表明每个事务是因为获取不到哪个事务持有的锁而阻塞。</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0909-GnpSfx.png" alt=""></p>
<ul>
<li>requesting_trx_id：表示因为获取不到锁而被阻塞的事务的事务id</li>
<li>blocking_trx_id：表示因为获取到别的事务需要的锁而导致其被阻塞的事务的事务Id。</li>
</ul>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0910-K0s0xk.png" alt=""></p>
<p>即<code>requesting_trx_id</code>表示事务B的事务Id，<code>blocking_trx_id</code>表示事务A的事务Id。</p>
<h3 id="show-engine-innodb-status"><a href="#show-engine-innodb-status" class="headerlink" title="show engine innodb status"></a>show engine innodb status</h3><p><strong>INNODB_LOCKS</strong> 和 <strong>INNODB_LOCK_WAITS</strong> 在MySQL 8.0已被移除，其实就是不鼓励我们用这两个表来获取表信息。而我们还可以用<code>show engine innodb status</code>获取当前系统各个事务的加锁信息。</p>
<p>在看死锁日志的时候，我们一般先把这个变量<code>innodb_status_output_locks</code>打开哈，它是MySQL 5.6.16 引入的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span>  innodb_status_output_locks <span class="operator">=</span><span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>
<p>在RR隔离级别下，我们交替执行事务A和B：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0910-fvUHhE.png" alt=""></p>
<p>show engine innodb status查看日志，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">TRANSACTIONS</span><br><span class="line"></span><br><span class="line">Trx id counter 1644854</span><br><span class="line">Purge done for trx&#x27;s n:o &lt; 1644847 undo n:o &lt; 0 state: running but idle</span><br><span class="line">History list length 32</span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">TRANSACTION 283263895935640, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">TRANSACTION 1644853, ACTIVE 7 sec inserting</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 1</span><br><span class="line">MySQL thread id 7, OS thread handle 11956, query id 563 localhost ::1 root update</span><br><span class="line">insert into t5 values(6,6,6)</span><br><span class="line">TRX HAS BEEN WAITING 7 SEC FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 267 page no 4 n bits 80 index c of table `test2`.`t5` trx id 1644853 lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 4; hex 8000000a; asc     ;;</span><br><span class="line"> 1: len 4; hex 8000000a; asc     ;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TABLE LOCK table `test2`.`t5` trx id 1644853 lock mode IX</span><br><span class="line">RECORD LOCKS space id 267 page no 4 n bits 80 index c of table `test2`.`t5` trx id 1644853 lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 4; hex 8000000a; asc     ;;</span><br><span class="line"> 1: len 4; hex 8000000a; asc     ;;</span><br></pre></td></tr></table></figure>
<p>这结构锁的关键词需要记住一下哈：</p>
<ul>
<li><code>lock_mode X locks gap before rec</code>表示X型的gap锁</li>
<li><code>lock_mode X locks rec but not gap</code>表示 X型的记录锁（Record Lock）</li>
<li><code>lock mode X</code> 一般表示 X型临键锁（next-key 锁）</li>
</ul>
<p>以上的锁日志，我们一般关注点，是一下这几个地方：</p>
<ul>
<li><code>TRX HAS BEEN WAITING 7 SEC FOR THIS LOCK TO BE GRANTED</code>表示它在等这个锁</li>
<li><code>RECORD LOCKS space id 267 page no 4 n bits 80 index c of table</code>test2<code>.</code>t5<code>trx id 1644853 lock_mode X locks gap before rec insert intention waiting</code>表示一个锁结构，这个锁结构的Space ID是267，page number是4，n_bits属性为80，对应的索引是<code>c</code>，这个锁结构中存放的锁类型是X型的插入意向Gap锁。</li>
<li><code>0: len 4; hex 8000000a; asc     ;;</code>对应加锁记录的详细信息，8000000a代表的值就是10，a的16进制是10。</li>
<li><code>TABLE LOCK table</code>test2<code>.</code>t5<code>trx id 1644853 lock mode IX</code> 表示一个插入意向表锁</li>
</ul>
<p>这个日志例子，其实理解起来，就是事务A持有了索引c的间隙锁<code>（~，10）</code>，而事务B想获得这个gap锁，而获取不到，就一直在等待这个插入意向锁。</p>
<h2 id="手把手死锁案例分析"><a href="#手把手死锁案例分析" class="headerlink" title="手把手死锁案例分析"></a>手把手死锁案例分析</h2><p>如果发生死锁了，我们应该如何分析呢？一般分为四个步骤：</p>
<ol>
<li><code>show engine innodb status</code>，查看最近一次死锁日志。</li>
<li>分析死锁日志，找到关键词<code>TRANSACTION</code></li>
<li>分析死锁日志，查看正在执行的SQL</li>
<li>看SQL持有什么锁，又在等待什么锁。</li>
</ol>
<h3 id="一个死锁的简单例子"><a href="#一个死锁的简单例子" class="headerlink" title="一个死锁的简单例子"></a>一个死锁的简单例子</h3><p>表结构和数据如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t6 ( id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, c <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, d <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>, <span class="keyword">PRIMARY</span> KEY (id), KEY c (c)) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t6 <span class="keyword">values</span>(<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>),(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>我们开启A、B事务，执行流程如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-ln71aR.png" alt=""></p>
<h3 id="6-2-分析死锁日志"><a href="#6-2-分析死锁日志" class="headerlink" title="6.2 分析死锁日志"></a>6.2 分析死锁日志</h3><ol>
<li><code>show engine innodb status</code>，查看最近一次死锁日志。如下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line"></span><br><span class="line">2022-05-03 22:53:22 0x2eb4</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 1644867, ACTIVE 31 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)</span><br><span class="line">MySQL thread id 5, OS thread handle 7068, query id 607 localhost ::1 root statistics</span><br><span class="line">Select * from t6 where id=10 for update</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 268 page no 3 n bits 72 index PRIMARY of table `test2`.`t6` trx id 1644867 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0</span><br><span class="line"> 0: len 4; hex 8000000a; asc     ;;</span><br><span class="line"> 1: len 6; hex 00000019193c; asc      &lt;;;</span><br><span class="line"> 2: len 7; hex dd00000191011d; asc        ;;</span><br><span class="line"> 3: len 4; hex 8000000a; asc     ;;</span><br><span class="line"> 4: len 4; hex 8000000a; asc     ;;</span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 1644868, ACTIVE 17 sec starting index read, thread declared inside InnoDB 5000</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">3 lock struct(s), heap size 1136, 2 row lock(s)</span><br><span class="line">MySQL thread id 7, OS thread handle 11956, query id 608 localhost ::1 root statistics</span><br><span class="line">Select * from t6 where id=5 for update</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 268 page no 3 n bits 72 index PRIMARY of table `test2`.`t6` trx id 1644868 lock_mode X locks rec but not gap</span><br><span class="line">Record lock, heap no 3 PHYSICAL RECORD: n_fields 5; compact format; info bits 0</span><br><span class="line"> 0: len 4; hex 8000000a; asc     ;;</span><br><span class="line"> 1: len 6; hex 00000019193c; asc      &lt;;;</span><br><span class="line"> 2: len 7; hex dd00000191011d; asc        ;;</span><br><span class="line"> 3: len 4; hex 8000000a; asc     ;;</span><br><span class="line"> 4: len 4; hex 8000000a; asc     ;;</span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 268 page no 3 n bits 72 index PRIMARY of table `test2`.`t6` trx id 1644868 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 2 PHYSICAL RECORD: n_fields 5; compact format; info bits 0</span><br><span class="line"> 0: len 4; hex 80000005; asc     ;;</span><br><span class="line"> 1: len 6; hex 00000019193c; asc      &lt;;;</span><br><span class="line"> 2: len 7; hex dd000001910110; asc        ;;</span><br><span class="line"> 3: len 4; hex 80000005; asc     ;;</span><br><span class="line"> 4: len 4; hex 80000005; asc     ;;</span><br></pre></td></tr></table></figure>
<ol>
<li>先找到关键词<code>TRANSACTION</code>，可以发现两部分的事务日志，如下：</li>
</ol>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0911-PPGGm6.png" alt=""></p>
<ol>
<li>查看正在执行，产生死锁的对应的SQL，如下：</li>
</ol>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0847-Xg3rgj.png" alt=""></p>
<ol>
<li>查看分开两部分的TRANSACTION，分别持有什么锁，和等待什么锁。</li>
</ol>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/06/0912-IadvAW.png" alt=""></p>
<p>所谓的死锁，其实就是，我持有你的需要的锁，你持有我需要的锁，形成相互等待的闭环。所以排查死锁问题时，照着这个思维去思考就好啦。</p>

      
    </div>
   <div>
        
    </div>

   
    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>

  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xuemingde.com/posts/2TEE5S1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="meadel">
      <meta itemprop="description" content="我的愿望，世界和平">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Middle's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/2TEE5S1.html" class="post-title-link" itemprop="url">数据库异常智能分析与诊断</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-05 00:00:00" itemprop="dateCreated datePublished" datetime="2022-05-05T00:00:00+08:00">2022-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-13 16:46:48" itemprop="dateModified" datetime="2022-08-13T16:46:48+08:00">2022-08-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          
            <span id="/posts/2TEE5S1.html" class="post-meta-item leancloud_visitors" data-flag-title="数据库异常智能分析与诊断" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/2TEE5S1.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/2TEE5S1.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文：<span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvUG1NVkJqQXpqZUpZV0JKSTM5Z2ZfZw==">数据库异常智能分析与诊断<i class="fa fa-external-link-alt"></i></span></p>
<p>DAS（Database Autonomy Service,  数据库自治服务）面向研发和DBA，是一款为用户提供数据库性能分析、故障诊断、安全管理等功能的数据库自治服务。DAS利用大数据手段、机器学习、专家经验，帮助用户消除数据库管理的复杂性及人工操作引发的服务故障，有效保障数据库服务的稳定和高效运行。本文主要讲述DAS的历史背景、演进策略、重要功能及实现思路，希望能对从事相关开发的同学有所帮助或者启发。</p>
</blockquote>
<h2 id="1-现状与问题"><a href="#1-现状与问题" class="headerlink" title="1 现状与问题"></a>1 现状与问题</h2><h3 id="1-1-规模增长与运维能力发展之间的不平衡问题凸显"><a href="#1-1-规模增长与运维能力发展之间的不平衡问题凸显" class="headerlink" title="1.1 规模增长与运维能力发展之间的不平衡问题凸显"></a>1.1 规模增长与运维能力发展之间的不平衡问题凸显</h3><p>伴随着最近几年美团业务的快速发展，数据库的规模也保持着高速增长。而作为整个业务系统的“神经末梢”，数据库一旦出现问题，对业务造成的损失就会非常大。同时，因数据库规模的快速增长，出现问题的数量也大大增加，完全依靠人力的被动分析与定位已经不堪重负。下图是当时数据库实例近年来的增长趋势：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2201-CyBaFC.png" alt="数据库实例增长趋势"></p>
<p>图1 数据库实例增长趋势</p>
<h3 id="1-2-理想很丰满，现实很骨感"><a href="#1-2-理想很丰满，现实很骨感" class="headerlink" title="1.2 理想很丰满，现实很骨感"></a>1.2 理想很丰满，现实很骨感</h3><p>美团数据库团队当前面临的主要矛盾是：实例规模增长与运维能力发展之间的不平衡，而主要矛盾体现在数据库稳定性要求较高与关键数据缺失。由于产品能力不足，只能依赖专业DBA手动排查问题，异常处理时间较长。因此，我们决定补齐关键信息，提供自助或自动定位问题的能力，缩短处理时长。</p>
<p>我们复盘了过去一段时间内的故障和告警，深入分析了这些问题的根因，发现任何一个异常其实都可以按时间拆分为异常预防、异常处理和异常复盘三阶段。针对这三阶段，结合MTTR的定义，然后调研了美团内部及业界的解决方案，我们做了一张涵盖数据库异常处理方案的全景图。如下图所示：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2201-5X6GWC.png" alt="运维能力的现状"></p>
<p>图2 运维能力的现状</p>
<p>通过对比，我们发现：</p>
<ul>
<li>每个环节我们都有相关的工具支撑，但能力又不够强，相比头部云厂商大概20%～30%左右的能力，短板比较明显。</li>
<li>自助化和自动化能力也不足，工具虽多，但整个链条没有打通，未形成合力。</li>
</ul>
<p>那如何解决这一问题呢？团队成员经过深入分析和讨论后，我们提出了一种比较符合当前发展阶段的解决思路。</p>
<h2 id="2-解决的思路"><a href="#2-解决的思路" class="headerlink" title="2 解决的思路"></a>2 解决的思路</h2><h3 id="2-1-既解决短期矛盾，也立足长远发展"><a href="#2-1-既解决短期矛盾，也立足长远发展" class="headerlink" title="2.1 既解决短期矛盾，也立足长远发展"></a>2.1 既解决短期矛盾，也立足长远发展</h3><p>从对历史故障的复盘来看，80%故障中80%的时间都花在分析和定位上。解决异常分析和定位效率短期的ROI（投资回报率）最高。长期来看，只有完善能力版图，才能持续不断地提升整个数据库的稳定性及保障能力。因此，我们当时的一个想法就是既要解决短期矛盾，又要立足长远发展（Think Big Picture, Think Long Term）。新的方案要为未来留足足够的发展空间，不能只是“头痛医头、脚痛医脚”。</p>
<p>在宏观层面，我们希望能将更多的功能做到自动定位，基于自动定位来自助或自动地处理变更，从而提高异常恢复的效率，最终提升用户体验。将异常处理效率提高和用户体验提升后，运维人员（主要是DBA）的沟通成本将会极大被降低，这样运维人员就有更多时间进行技术投入，能将更多“人肉处理”的异常变成自助或自动处理，从而形成“飞轮效应”。最终达成高效的稳定性保障的目标。</p>
<p>在微观层面，我们基于已有的数据，通过结构化的信息输出，提升可观测性，补齐关键数据缺失的短板。同时，我们基于完善的信息输出，通过规则（专家经验）和AI的配合，提供自助或自动定位的能力，缩短处理时长。</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2202-JGcrs3.png" alt="宏观和微观">图3 宏观和微观</p>
<h3 id="2-2-夯实基础能力，赋能上层业务，实现数据库自治"><a href="#2-2-夯实基础能力，赋能上层业务，实现数据库自治" class="headerlink" title="2.2 夯实基础能力，赋能上层业务，实现数据库自治"></a>2.2 夯实基础能力，赋能上层业务，实现数据库自治</h3><p>有了明确的指导思想，我们该采取怎样的发展策略和路径呢？就当时团队的人力情况来看，没有同学有过类似异常自治的开发经验，甚至对数据库的异常分析的能力都还不具备，人才结构不能满足产品的终极目标。所谓“天下大事必作于细，天下难事必作于易”。我们思路是从小功能和容易的地方入手，先完指标监控、慢查询、活跃会话这些简单的功能，再逐步深入到全量SQL、异常根因分析和慢查询优化建议等这些复杂的功能，通过这些基础工作来“借假修真”，不断提升团队攻坚克难的能力，同时也可以为智能化打下一个良好的基础。</p>
<p>以下便是我们根据当时人才结构以及未来目标设定的2年路径规划（实现数据自治目标规划在2022以后的启动，下图会省略掉这部分）：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2202-wGE2o5.png" alt="演进策略">图4 演进策略</p>
<h3 id="2-3-建立科学的评估体系，持续的跟踪产品质量"><a href="#2-3-建立科学的评估体系，持续的跟踪产品质量" class="headerlink" title="2.3 建立科学的评估体系，持续的跟踪产品质量"></a>2.3 建立科学的评估体系，持续的跟踪产品质量</h3><p>美国著名管理学者卡普兰说过：“没有度量就没有管理”。只有建立科学的评估体系，才能推进产品不断迈向更高峰，怎样评估产品的质量并持续改善呢？之前我们也做过很多指标，但都不可控，没有办法指导我们的工作。比如，我们最开始考虑根因定位使用的是结果指标准确率和召回率，但结果指标不可控难以指导我们的日常工作。这就需要找其中的可控因素，并不断改善。</p>
<p>我们在学习亚马逊的时候，刚好发现他们有一个可控输入和输出指标的方法论，就很好地指导了我们的工作。只要在正确的可控输入指标上不断优化和提升，最终我们的输出指标也能够得到提升（这也印证了曾国藩曾说过的一句话：“在因上致力，但在果上随缘”）。</p>
<p>以下是我们关于根因定位的指标设计和技术实现思路（在模拟环境不断提升可控的部分，最终线上的实际效果也会得到提升。主要包括“根因定位可控输入和输出指标设计思路”和“根因定位可控输入指标获取的技术实现思路”）。</p>
<p><strong>根因定位可控输入和输出指标设计思路</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2202-23JWut.png" alt="图5 可控输入与输出指标设计"></p>
<p><strong>根因定位可控输入指标获取的技术实现思路</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2204-gZVnC7.png" alt="可控输入与输出指标技术设计"></p>
<p>在图5中，我们通过场景复现方式，用技术手段来模拟一些用低成本就能实现的异常（绝大部份异常）。在对于复现成本比较高的异常（极少部分），比如机器异常、硬件故障等，我们目前的思路是通过“人肉运营”的方式，发现和优化问题，等到下次线上异常重复发生后，根据优化后诊断的结果，通过和预期比较来确定验收是否通过。</p>
<p>未来我们会建立回溯系统，将发生问题时刻的异常指标保存，通过异常指标输入給回溯系统后的输出结果，判断系统改进的有效性，从而构建更加轻量和更广覆盖的复现方式。图6是复现系统的具体技术实现思路。</p>
<p>有了指导思想，符合当前发展阶段的路径规划以及科学的评估体系后，接下来聊聊技术方案的构思。</p>
<h2 id="3-技术方案"><a href="#3-技术方案" class="headerlink" title="3 技术方案"></a>3 技术方案</h2><h3 id="3-1-技术架构的顶层设计"><a href="#3-1-技术架构的顶层设计" class="headerlink" title="3.1 技术架构的顶层设计"></a>3.1 技术架构的顶层设计</h3><p>在技术架构顶层设计上，我们秉承平台化、自助化、智能化和自动化四步走的演进策略。</p>
<p>首先，我们要完善可观测的能力，通过关键信息的展示，构建一个易用的数据库监控平台。然后我们根据这些关键信息为变更（比如数据变更和索引变更等）提供赋能，将一部分高频运维工作通过这些结构化的关键信息（比如索引变更，可以监测近期是否有访问流量，来确保变更安全性）让用户自主决策，也就是自助化。接下来，我们加入一些智能的元素（专家经验+AI），进一步覆盖自助化的场景，并逐步将部分低风险的功能自动化，最终通过系统的不断完善，走到高级或完全自动化的阶段。</p>
<p>为什么我们将自动化放在智能化之后？因为我们认为智能化的目标也是为了自动化，智能化是自动化的前提，自动化是智能化的结果。只有不断提升智能化，才能达到高级或者完全自动化。下图便是我们的顶层架构设计（左侧是演进策略，右侧是技术架构的顶层设计以及2021年底的现状）：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2205-iCsfIF.png" alt="图7 架构顶层设计"></p>
<p>顶层设计只是“万里长征第一步”，接下来我们将自底向上逐步介绍我们基于顶层设计开展的具体工作，将从数据采集层的设计、计算存储层的设计和分析决策层的设计逐步展开。</p>
<h3 id="3-2-数据采集层的设计"><a href="#3-2-数据采集层的设计" class="headerlink" title="3.2 数据采集层的设计"></a>3.2 数据采集层的设计</h3><p>这上面的架构图里，数据采集层是所有链路的最底层和最重要的环节，采集数据的质量直接决定了整个系统的能力。同时，它和数据库实例直接打交道，任何设计上的缺陷都将可能导致大规模的故障。所以，技术方案上必须兼顾数据采集质量和实例稳定性，在二者无法平衡的情况下，宁可牺牲掉采集质量也要保证数据库的稳定性。</p>
<p>在数据采集上，业界都采取基于内核的方式，但美团自研内核较晚，而且部署周期长，所以我们短期的方式是采用抓包的方式做一个过渡，等基于内核的采集部署到一定规模后再逐步切换过来。以下是我们基于抓包思路的技术方案调研：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-YI2cBB.png" alt="图片"></p>
<p>从调研上我们可以看到，基于pf_ring和dpdk的方案都有较大的依赖性，短期难以实现，之前也没有经验。但是，基于pcap的方式没有依赖，我们也有过一定的经验，之前美团酒旅团队基于抓包的方式做过全量SQL数据采集的工具，并经过了1年时间的验证。因此，我们最终采取了基于pcap抓包方式的技术方案。以下是采集层方案的架构图和采集质量以及对数据库性能带来的影响情况。</p>
<p><strong>Agent的技术设计</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2210-geH61R.png" alt="图8 Agent的技术设计"></p>
<p><strong>对数据库的影响</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-Sy4oxH.png" alt="图9 Agent对数据库的影响测试"></p>
<h3 id="3-3-计算存储层的设计"><a href="#3-3-计算存储层的设计" class="headerlink" title="3.3 计算存储层的设计"></a>3.3 计算存储层的设计</h3><p>由于美团整个数据库实例数量和流量巨大，而且随着业务的快速发展，还呈现出快速增长的态势。所以，我们的设计不仅要满足当前，还要考虑未来5年及更长的时间也能够满足要求。同时，对数据库故障分析来说，数据的实时性和完备性是快速和高效定位问题的关键，而保证数据实时性和完备性需要的容量成本也不容忽视。因此，结合上述要求和其他方面的一些考虑，我们对该部分设计提出了一些原则，主要包括：</p>
<ul>
<li><strong>全内存计算</strong>：确保所有的计算都在单线程内或单进程内做纯内存的操作，追求性能跟吞吐量的极致。</li>
<li><strong>上报原始数据</strong>：MySQL实例上报的数据尽量维持原始数据状态，不做或者尽量少做数据加工。<br><strong>数据压缩</strong>：由于上报量巨大，需要保障上报的数据进行极致的压缩。</li>
<li><strong>内存消耗可控</strong>：通过理论和实际压测保障几乎不可能会发生内存溢出。</li>
<li><strong>最小化对MySQL实例的影响</strong>：计算尽量后置，不在Agent上做复杂计算，确保不对RDS实例生产较大影响。以下是具体的架构图：</li>
</ul>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2210-fPWx39.png" alt="图10 Agent对数据库的影响测试"></p>
<p>全量SQL（所有访问数据库的SQL）是整个系统最具挑战的功能，也是数据库异常分析最重要的信息之一，因此会就全量SQL的聚合方式、聚合和压缩的效果和补偿设计做一些重点的介绍。</p>
<h4 id="3-3-1-全量SQL的聚合方式"><a href="#3-3-1-全量SQL的聚合方式" class="headerlink" title="3.3.1 全量SQL的聚合方式"></a>3.3.1 全量SQL的聚合方式</h4><p>由于明细数据巨大，我们采取了聚合的方式。消费线程会对相同模板SQL的消息按分钟粒度进行聚合计算，以“RDSIP+DBName+SQL模版ID+SQL查询结束时间所在分钟数”为聚合键。聚合健的计算公式为：Aggkey=RDS_IP_DBName_SQL_Template_ID_Time_Minute （Time_Minute的值取自SQL查询结束时间所在的“年、月、日、时、分钟”）</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-PL7fzf.png" alt="图11 SQL模版聚合设计"></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2209-w25SD2.png" alt="图12 SQL模版聚合方法"></p>
<h4 id="3-3-2-全量SQL数据聚合和压缩的效果"><a href="#3-3-2-全量SQL数据聚合和压缩的效果" class="headerlink" title="3.3.2 全量SQL数据聚合和压缩的效果"></a>3.3.2 全量SQL数据聚合和压缩的效果</h4><p>在数据压缩方面，遵循层层减流原则，使用消息压缩、预聚合、字典化、分钟级聚合的手段，保证流量在经过每个组件时进行递减，最终达到节省带宽减少存储量的目的。以下是相关的压缩环节和测试数据表现情况（敏感数据做了脱敏，不代表美团实际的情况）：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2209-kJtMW2.png" alt="图13 全量SQL压缩设计与效果"></p>
<h4 id="3-3-3-全量SQL数据补偿机制"><a href="#3-3-3-全量SQL数据补偿机制" class="headerlink" title="3.3.3 全量SQL数据补偿机制"></a>3.3.3 全量SQL数据补偿机制</h4><p>如上所述，在数据聚合端是按一分钟进行聚合，并允许额外一分钟的消息延迟，如果消息延迟超过1分钟会被直接丢弃掉，这样在业务高峰期延迟比较严重的场景下，会丢失比较大量的数据，从而对后续数据库异常分析的准确性造成较大的影响。</p>
<p>因此，我们增加了延迟消息补偿机制，对过期的数据发入补偿队列（采用的是美团消息队列服务Mafka），通过过期数据补偿的方式，保证延迟久的消息也能正常存储，通过最终一致性保证了后续的数据库异常分析的准确性。以下是数据补偿机制的设计方案：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2209-Qa04g2.png" alt="图14 全量SQL补全技术设计"></p>
<h3 id="3-4-分析决策层的设计"><a href="#3-4-分析决策层的设计" class="headerlink" title="3.4 分析决策层的设计"></a>3.4 分析决策层的设计</h3><p>在有了比较全的数据之后，接下来就是基于数据进行决策，推断出可能的根因。这部分我们使用了基于专家经验结合AI的方式。我们把演进路径化分为了四个阶段：</p>
<ul>
<li><strong>第一阶段</strong>：完全以规则为主，积累领域经验，探索可行的路径。</li>
<li><strong>第二阶段</strong>：探索AI场景，但以专家经验为主，在少量低频场景上使用AI算法，验证AI能力。</li>
<li><strong>第三阶段</strong>：在专家经验和AI上齐头并进，专家经验继续在已有的场景上迭代和延伸，AI在新的场景上进行落地，通过双轨制保证原有能力不退化。</li>
<li><strong>第四阶段</strong>：完成AI对大部分专家经验的替换，以AI为主专家经验为辅，极致发挥AI能力。</li>
</ul>
<p>以下是分析决策部分整体的技术设计（我们参考了华为一篇文章：<span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3M/X19iaXo9TXpBd016Y3hORE00TWc9PSZhbXA7bWlkPTI2NDkwNzk4MzMmYW1wO2lkeD0xJmFtcDtzbj1mMTMxZGU1MWRlZmUxZTNhNjEyNWYxZjBkMGYxMTdlNyZhbXA7c2NlbmU9MjEjd2VjaGF0X3JlZGlyZWN0">《网络云根因智荐的探索与实践》<i class="fa fa-external-link-alt"></i></span>）：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2208-O1SL2x.png" alt="图15 分析决策的技术设计"></p>
<p>在决策分析层，我们主要采取了专家经验和AI两者方式，接下来会介绍专家经验（基于规则的方式）和AI方式（基于AI算法的方式）的相关实现。</p>
<h4 id="3-4-1-基于规则的方式"><a href="#3-4-1-基于规则的方式" class="headerlink" title="3.4.1 基于规则的方式"></a>3.4.1 基于规则的方式</h4><p>专家经验部分，我们采取了GRAI（Goal、Result、Analysis和Insight的简称）的复盘方法论来指导工作，通过持续、大量、高频的复盘，我们提炼了一些靠谱的规则，并通过持续的迭代，不断提升准确率和召回率。下面例举的是主从延迟的规则提炼过程：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2207-5DEpsK.png" alt="图16 专家经验的复盘和改进"></p>
<h4 id="3-4-2-基于AI算法的方式"><a href="#3-4-2-基于AI算法的方式" class="headerlink" title="3.4.2 基于AI算法的方式"></a>3.4.2 基于AI算法的方式</h4><p><strong>异常数据库指标检测</strong></p>
<p>数据库核心指标的异常检测依赖于对指标历史数据的合理建模，通过将离线过程的定期建模与实时过程的流检测相结合，将有助于在数据库实例存在故障或风险的情况下，有效地定位根本问题所在，从而实现及时有效地解决问题。</p>
<p>建模过程主要分为3个流程。首先，我们通过一些前置的模块对指标的历史数据进行预处理，包含缺失数值填充，数据的平滑与聚合等过程。随后，我们通过分类模块创建了后续的不同分支，针对不同类型的指标运用不同的手段来建模。最终，将模型进行序列化存储后提供Flink任务读取实现流检测。</p>
<p><strong>以下是检测的设计图</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-scJKSt.png" alt="图17 基于AI的异常检测设计"></p>
<p><strong>根因诊断（构建中）</strong></p>
<p>订阅告警消息（基于规则或者异常检测触发），触发诊断流程，采集、分析数据，推断出根因并筛选出有效信息辅助用户解决。诊断结果通过大象通知用户，并提供诊断诊断详情页面，用户可通过标注来优化诊断准确性。</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2207-BlS0lM.png" alt="图18 基于AI的异常检测设计"></p>
<ul>
<li><strong>数据采集</strong>：采集数据库性能指标、数据库状态抓取、系统指标、硬件问题、日志、记录等数据。</li>
<li><strong>特征提取</strong>：从各类数据中提取特征，包括算法提取的时序特征、文本特征以及利用数据库知识提取的领域特征等。</li>
<li><strong>根因分类</strong>：包括特征预处理、特征筛选、算法分类、根因排序等部分。</li>
<li><strong>根因扩展</strong>：基于根因类别进行相关信息的深入挖掘，提高用户处理问题的效率。具体包括SQL行为分析、专家规则、指标关联、维度下钻、日志分析等功能模块。</li>
</ul>
<p><strong>4 建设成果</strong></p>
<p><strong>4.1 指标表现</strong></p>
<p>我们目前主要是通过“梳理触发告警场景-&gt;模拟复现场景-&gt;根因分析和诊断-&gt;改进计划-&gt;验收改进质量-&gt;梳理触发告警场景”的闭环方法（详情请参考前文<strong>建立科学的评估体系，持续的跟踪产品质量</strong>部分），持续不断的进行优化和迭代。通过可控输入指标的提升，来优化改善线上的输出指标，从而保证系统不断的朝着正确的方向发展。以下是近期根因召回率和准确率指标表现情况。</p>
<p><strong>用户告警根因反馈准确率</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2207-ujdjsQ.png" alt="图19 用户反馈准确率"></p>
<p><strong>告警诊断分析总体召回率</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-qrXR5n.png" alt="图20 根因分析召回率"></p>
<h3 id="4-2-用户案例"><a href="#4-2-用户案例" class="headerlink" title="4.2 用户案例"></a>4.2 用户案例</h3><p>在根因结果推送上，我们和美团内部的IM系统（大象）进行了打通，出现问题后通过告警发现异常-&gt;大象推送诊断根因-&gt;点击诊断链接详情查看详细信息-&gt;一键预案处理-&gt;跟踪反馈处理的效果-&gt;执行成功或者回滚，来完成异常的发现、定位、确认和处理的闭环。以下是活跃会话规则触发告警后根因分析的一个案例。</p>
<p><strong>自动拉群，并给出根因</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-H2dlf3.png" alt="图21 锁阻塞导致活跃会话过高"></p>
<p><strong>点击诊断报告，查看详情</strong></p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-zWL0uT.png" alt="图22 锁阻塞导致活跃会话过高"></p>
<p>以下是出现Load告警后，我们的一个慢查询优化建议推送案例（脱敏原因，采用了测试环境模拟的案例）。</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/05/05/2206-IbCL8r.png" alt="图23 慢查询优化建议"></p>
<h2 id="5-总结与未来展望"><a href="#5-总结与未来展望" class="headerlink" title="5 总结与未来展望"></a>5 总结与未来展望</h2><p>数据库自治服务经过2年左右的发展，已基本夯实了基础能力，在部分业务场景上完成了初步赋能（比如针对问题SQL，业务服务上线发布前自动识别，提示潜在风险；针对索引误变更，工单执行前自动检测索引近期访问流量，阻断误变更等）。接下来，我们的目标除了在已完成工作上继续深耕，提升能力外，重点会瞄准数据库自治能力。主要的工作规划将围绕以下3个方向：</p>
<p><strong>（1）计算存储能力增强</strong>：随着数据库实例和业务流量的持续高速增长，以及采集的信息的不断丰富，亟需对现有数据通道能力进行增强，确保能支撑未来3-5年的处理能力。</p>
<p><strong>（2）自治能力在少部分场景上落地</strong>：数据库自治能力上，会采取三步走的策略：</p>
<ul>
<li>第一步：建立根因诊断和SOP文档的关联，将诊断和处理透明化；</li>
<li>第二步：SOP文档平台化，将诊断和处理流程化；</li>
<li>第三步：部分低风险无人干预，将诊断和处理自动化，逐步实现数据库自治。</li>
</ul>
<p><strong>（3）更灵活的异常回溯系统</strong>：某个场景根因定位算法在上线前或者改进后的验证非常关键，我们会完善验证体系，建立灵活的异常回溯系统，通过基于现场信息的回放来不断优化和提升系统定位准确率。</p>

      
    </div>
   <div>
        
    </div>

   
    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>

  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xuemingde.com/posts/3DM6SJ9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="meadel">
      <meta itemprop="description" content="我的愿望，世界和平">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Middle's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/3DM6SJ9.html" class="post-title-link" itemprop="url">Hutool返回树结构工具类TreeUtil</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-29 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-29T00:00:00+08:00">2022-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-13 16:46:48" itemprop="dateModified" datetime="2022-08-13T16:46:48+08:00">2022-08-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%80%A0%E8%BD%AE%E5%AD%90/" itemprop="url" rel="index"><span itemprop="name">造轮子</span></a>
                </span>
            </span>

          
            <span id="/posts/3DM6SJ9.html" class="post-meta-item leancloud_visitors" data-flag-title="Hutool返回树结构工具类TreeUtil" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/3DM6SJ9.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/3DM6SJ9.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>考虑到菜单等需求的普遍性，有用户提交了一个扩展性极好的树状结构实现。这种树状结构可以根据配置文件灵活的定义节点之间的关系，也能很好的兼容关系数据库中数据</p>
<p>数据的实体类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MenuInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8839460886585312600L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;varchar(50)  comment &#x27;菜单名称&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String menuName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;varchar(50)  comment &#x27;允许操作编码&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String permission;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;varchar(50)  comment &#x27;菜单地址&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;int(1)  comment &#x27;父级ID&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer parentId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;varchar(50)  comment &#x27;菜单图标&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;int(1)  comment &#x27;排序&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;int(1)  comment &#x27;路由缓冲&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer keepAlive;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(columnDefinition = &quot;int(1)  comment &#x27;菜单类型,0:菜单 1:按钮&#x27;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库数据如下：</p>
<p><img data-src="https://xuemingde.com/pages/image/2022/04/29/1021-c2LkKr.png" alt=""></p>
<p>查询出来的数据源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;MenuInfo&gt; menuInfos = <span class="keyword">this</span>.menuService.list();</span><br></pre></td></tr></table></figure>
<p>将<code>List&lt;MenuInfo&gt;</code>转化为树结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Tree&lt;Integer&gt;&gt; menuTreeConvert(List&lt;MenuInfo&gt; menuInfos,Integer parentId)&#123;</span><br><span class="line">    List&lt;TreeNode&lt;Integer&gt;&gt; nodeList = menuInfos.stream().map(menuInfo -&gt; &#123;</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//扩展字段</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;type&quot;</span>, menuInfo.getType());</span><br><span class="line">        map.put(<span class="string">&quot;keepAlive&quot;</span>, menuInfo.getKeepAlive());</span><br><span class="line">        map.put(<span class="string">&quot;icon&quot;</span>, menuInfo.getIcon());</span><br><span class="line">        map.put(<span class="string">&quot;path&quot;</span>, menuInfo.getPath());</span><br><span class="line">        map.put(<span class="string">&quot;sort&quot;</span>, menuInfo.getSort());</span><br><span class="line">        map.put(<span class="string">&quot;permission&quot;</span>, menuInfo.getPermission());</span><br><span class="line">      </span><br><span class="line">        TreeNode&lt;Integer&gt; treeNode = <span class="keyword">new</span> TreeNode&lt;Integer&gt;()</span><br><span class="line">                 <span class="comment">//ID</span></span><br><span class="line">                .setId(menuInfo.getId())</span><br><span class="line">                .setName(menuInfo.getMenuName())</span><br><span class="line">                .setParentId(menuInfo.getParentId())</span><br><span class="line">                .setWeight(menuInfo.getSort())</span><br><span class="line">                .setExtra(map);</span><br><span class="line">        <span class="keyword">return</span> treeNode;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//配置</span></span><br><span class="line">    TreeNodeConfig treeNodeConfig = <span class="keyword">new</span> TreeNodeConfig();</span><br><span class="line">    treeNodeConfig.setChildrenKey(<span class="string">&quot;children&quot;</span>);</span><br><span class="line">    treeNodeConfig.setParentIdKey(<span class="string">&quot;parentId&quot;</span>);</span><br><span class="line">    treeNodeConfig.setNameKey(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    treeNodeConfig.setWeightKey(<span class="string">&quot;sort&quot;</span>);</span><br><span class="line">    <span class="comment">// 最大递归深度</span></span><br><span class="line">    treeNodeConfig.setDeep(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">//转换器</span></span><br><span class="line">   <span class="keyword">return</span> TreeUtil.build(nodeList,parentId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回实例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">           <span class="attr">&quot;parentId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;weight&quot;</span>: <span class="number">1</span>,</span><br><span class="line">           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;容器管理&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/container&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-mokuai&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;sort&quot;</span>: <span class="number">1</span>,</span><br><span class="line">           <span class="attr">&quot;type&quot;</span>: <span class="number">0</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">           <span class="attr">&quot;parentId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;weight&quot;</span>: <span class="number">2</span>,</span><br><span class="line">           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;样本源管理&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/sample_source&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-zaixianyonghu&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">           <span class="attr">&quot;type&quot;</span>: <span class="number">0</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">           <span class="attr">&quot;parentId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;weight&quot;</span>: <span class="number">3</span>,</span><br><span class="line">           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;样本管理&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/sample_manage&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-yangbenzu&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;sort&quot;</span>: <span class="number">3</span>,</span><br><span class="line">           <span class="attr">&quot;type&quot;</span>: <span class="number">0</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">           <span class="attr">&quot;parentId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;weight&quot;</span>: <span class="number">4</span>,</span><br><span class="line">           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;随访管理&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/followup&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-gongyingshang2&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;sort&quot;</span>: <span class="number">4</span>,</span><br><span class="line">           <span class="attr">&quot;type&quot;</span>: <span class="number">0</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">&quot;id&quot;</span>: <span class="number">5</span>,</span><br><span class="line">           <span class="attr">&quot;parentId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;weight&quot;</span>: <span class="number">5</span>,</span><br><span class="line">           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;数据采集&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/plc&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-wodeyingyong&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;sort&quot;</span>: <span class="number">5</span>,</span><br><span class="line">           <span class="attr">&quot;type&quot;</span>: <span class="number">0</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="attr">&quot;id&quot;</span>: <span class="number">6</span>,</span><br><span class="line">           <span class="attr">&quot;parentId&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;weight&quot;</span>: <span class="number">6</span>,</span><br><span class="line">           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;权限管理&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/user&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-renwu&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">           <span class="attr">&quot;sort&quot;</span>: <span class="number">6</span>,</span><br><span class="line">           <span class="attr">&quot;type&quot;</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">&quot;children&quot;</span>: [</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="attr">&quot;id&quot;</span>: <span class="number">7</span>,</span><br><span class="line">                   <span class="attr">&quot;parentId&quot;</span>: <span class="number">6</span>,</span><br><span class="line">                   <span class="attr">&quot;weight&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;菜单管理&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/admin/menu/index&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                   <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-caidan&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;sort&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                   <span class="attr">&quot;type&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                   <span class="attr">&quot;children&quot;</span>: [</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="attr">&quot;id&quot;</span>: <span class="number">8</span>,</span><br><span class="line">                           <span class="attr">&quot;parentId&quot;</span>: <span class="number">7</span>,</span><br><span class="line">                           <span class="attr">&quot;weight&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;菜单查阅&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;sys_menu_view&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;sort&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                           <span class="attr">&quot;type&quot;</span>: <span class="number">1</span></span><br><span class="line">                       &#125;,</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="attr">&quot;id&quot;</span>: <span class="number">9</span>,</span><br><span class="line">                           <span class="attr">&quot;parentId&quot;</span>: <span class="number">7</span>,</span><br><span class="line">                           <span class="attr">&quot;weight&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;菜单新增&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;sys_menu_add&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                           <span class="attr">&quot;type&quot;</span>: <span class="number">1</span></span><br><span class="line">                       &#125;,</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="attr">&quot;id&quot;</span>: <span class="number">10</span>,</span><br><span class="line">                           <span class="attr">&quot;parentId&quot;</span>: <span class="number">7</span>,</span><br><span class="line">                           <span class="attr">&quot;weight&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;菜单修改&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;sys_menu_edit&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;sort&quot;</span>: <span class="number">3</span>,</span><br><span class="line">                           <span class="attr">&quot;type&quot;</span>: <span class="number">1</span></span><br><span class="line">                       &#125;,</span><br><span class="line">                       &#123;</span><br><span class="line">                           <span class="attr">&quot;id&quot;</span>: <span class="number">11</span>,</span><br><span class="line">                           <span class="attr">&quot;parentId&quot;</span>: <span class="number">7</span>,</span><br><span class="line">                           <span class="attr">&quot;weight&quot;</span>: <span class="number">4</span>,</span><br><span class="line">                           <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;菜单删除&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                           <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;sys_menu_del&quot;</span>,</span><br><span class="line">                           <span class="attr">&quot;sort&quot;</span>: <span class="number">4</span>,</span><br><span class="line">                           <span class="attr">&quot;type&quot;</span>: <span class="number">1</span></span><br><span class="line">                       &#125;</span><br><span class="line">                   ]</span><br><span class="line">               &#125;,</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="attr">&quot;id&quot;</span>: <span class="number">12</span>,</span><br><span class="line">                   <span class="attr">&quot;parentId&quot;</span>: <span class="number">6</span>,</span><br><span class="line">                   <span class="attr">&quot;weight&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                   <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;用户管理&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/admin/user/index&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;keepAlive&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                   <span class="attr">&quot;icon&quot;</span>: <span class="string">&quot;icon-wodezhanghu&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;permission&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                   <span class="attr">&quot;sort&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                   <span class="attr">&quot;type&quot;</span>: <span class="number">0</span></span><br><span class="line">               &#125;</span><br><span class="line">           ]</span><br><span class="line">       &#125;</span><br><span class="line">   ]</span><br></pre></td></tr></table></figure>

      
    </div>
   <div>
        
    </div>

   
    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>

  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xuemingde.com/posts/3E561CR.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/touxiang.jpeg">
      <meta itemprop="name" content="meadel">
      <meta itemprop="description" content="我的愿望，世界和平">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Middle's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/posts/3E561CR.html" class="post-title-link" itemprop="url">OAuth2的一个简单解释</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-27 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-27T00:00:00+08:00">2022-04-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-13 16:46:48" itemprop="dateModified" datetime="2022-08-13T16:46:48+08:00">2022-08-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">安全框架</span></a>
                </span>
            </span>

          
            <span id="/posts/3E561CR.html" class="post-meta-item leancloud_visitors" data-flag-title="OAuth2的一个简单解释" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/posts/3E561CR.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/posts/3E561CR.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>原文：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE5LzA0L29hdXRoX2Rlc2lnbi5odG1s">OAuth 2.0 的一个简单解释<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE0LzA1L29hdXRoXzJfMC5odG1s">OAuth 2.0<i class="fa fa-external-link-alt"></i></span> 是目前最流行的授权机制，用来授权第三方应用，获取用户数据。</p>
<p>这个标准比较抽象，使用了很多术语，初学者不容易理解。其实说起来并不复杂，下面我就通过一个简单的类比，帮助大家轻松理解，OAuth 2.0 到底是什么。</p>
<h2 id="快递员问题"><a href="#快递员问题" class="headerlink" title="快递员问题"></a>快递员问题</h2><p>我住在一个大型的居民小区。</p>
<p>小区有门禁系统。</p>
<p>进入的时候需要输入密码。</p>
<p>我经常网购和外卖，每天都有快递员来送货。我必须找到一个办法，让快递员通过门禁系统，进入小区。</p>
<p>如果我把自己的密码，告诉快递员，他就拥有了与我同样的权限，这样好像不太合适。万一我想取消他进入小区的权力，也很麻烦，我自己的密码也得跟着改了，还得通知其他的快递员。</p>
<p>有没有一种办法，让快递员能够自由进入小区，又不必知道小区居民的密码，而且他的唯一权限就是送货，其他需要密码的场合，他都没有权限？</p>
<h2 id="授权机制的设计"><a href="#授权机制的设计" class="headerlink" title="授权机制的设计"></a>授权机制的设计</h2><p>于是，我设计了一套授权机制。</p>
<p>第一步，门禁系统的密码输入器下面，增加一个按钮，叫做”获取授权”。快递员需要首先按这个按钮，去申请授权。</p>
<p>第二步，他按下按钮以后，屋主（也就是我）的手机就会跳出对话框：有人正在要求授权。系统还会显示该快递员的姓名、工号和所属的快递公司。</p>
<p>我确认请求属实，就点击按钮，告诉门禁系统，我同意给予他进入小区的授权。</p>
<p>第三步，门禁系统得到我的确认以后，向快递员显示一个进入小区的令牌（access token）。令牌就是类似密码的一串数字，只在短期内（比如七天）有效。</p>
<p>第四步，快递员向门禁系统输入令牌，进入小区。</p>
<p>有人可能会问，为什么不是远程为快递员开门，而要为他单独生成一个令牌？这是因为快递员可能每天都会来送货，第二天他还可以复用这个令牌。另外，有的小区有多重门禁，快递员可以使用同一个令牌通过它们。</p>
<h2 id="互联网场景"><a href="#互联网场景" class="headerlink" title="互联网场景"></a>互联网场景</h2><p>我们把上面的例子搬到互联网，就是 OAuth 的设计了。</p>
<p>首先，居民小区就是储存用户数据的网络服务。比如，微信储存了我的好友信息，获取这些信息，就必须经过微信的”门禁系统”。</p>
<p>其次，快递员（或者说快递公司）就是第三方应用，想要穿过门禁系统，进入小区。</p>
<p>最后，我就是用户本人，同意授权第三方应用进入小区，获取我的数据。</p>
<p><strong>简单说，OAuth 就是一种授权机制。数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用。</strong></p>
<h2 id="令牌与密码"><a href="#令牌与密码" class="headerlink" title="令牌与密码"></a>令牌与密码</h2><p>令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。</p>
<p>（1）令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化。</p>
<p>（2）令牌可以被数据所有者撤销，会立即失效。以上例而言，屋主可以随时取消快递员的令牌。密码一般不允许被他人撤销。</p>
<p>（3）令牌有权限范围（scope），比如只能进小区的二号门。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。</p>
<p>上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点。</p>
<p>注意，只要知道了令牌，就能进入系统。系统一般不会再次确认身份，所以<strong>令牌必须保密，泄漏令牌与泄漏密码的后果是一样的。</strong> 这也是为什么令牌的有效期，一般都设置得很短的原因。</p>
<p>OAuth 2.0 对于如何颁发令牌的细节，规定得非常详细。具体来说，一共分成四种授权类型（authorization grant），即四种颁发令牌的方式，适用于不同的互联网场景。<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE5LzA0L29hdXRoLWdyYW50LXR5cGVzLmh0bWw=">下一篇文章<i class="fa fa-external-link-alt"></i></span>，我就来介绍这四种类型，并给出代码实例。</p>
<p>（完）</p>

      
    </div>
   <div>
        
    </div>

   
    
    
    
      

      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>

  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



           </div>
          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

          
        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="meadel"
      src="/images/touxiang.jpeg">
  <p class="site-author-name" itemprop="name">meadel</p>
  <div class="site-description" itemprop="description">我的愿望，世界和平</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">154</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vdXNlci80MDE5NDcwMjQ0MjU4NTUyL3Bvc3Rz" title="掘金 → https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;4019470244258552&#x2F;posts"><i class="fa fa-share-alt fa-fw"></i>掘金</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3h1ZV9taW5k" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;xue_mind"><i class="fa fa-th-list fa-fw"></i>CSDN</span>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-star"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">meadel</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">846k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:49</span>
</div>
  <div class="powered-by">这个世界会好吗？我是那么热爱这个世界。  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="js/canvas-ribbon.js"></script>
  <script src="//lib.baomitu.com/animejs/3.2.1/anime.min.js"></script>
  <script src="//lib.baomitu.com/next-theme-pjax/0.5.0/pjax.min.js"></script>
  <script src="//lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script>
  <script src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lib.baomitu.com/medium-zoom/1.0.6/medium-zoom.min.js"></script>
  <script src="https://lib.baomitu.com/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="https://lib.baomitu.com/pangu/4.0.7/pangu.min.js"></script>
  <script src="//lib.baomitu.com/velocity/1.5.2/velocity.min.js"></script>
  <script src="//lib.baomitu.com/velocity/1.5.2/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>


  <script defer src="js/three.min.js"></script>


  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>



  <script data-pjax>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : 34163,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  
<script src="/js/local-search.js"></script>









<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




    <div id="pjax">
  

  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lib.baomitu.com/valine/1.4.17/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'xOnoKG9QyBMz9vYupNusn9fn-gzGzoHsz',
      appKey     : 'RfiNClAkp7Ewe9rlzrjAQEXC',
      placeholder: "吐槽一下...",
      avatar     : 'monsterid',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields : ['nick','mail']
    });
  }, window.Valine);
});
</script>

    </div>
  <link rel="stylesheet" href="/dist/APlayer.min.css">
  <div id="aplayer"></div>
  <script type="text/javascript" src="/dist/APlayer.min.js"></script>
  <script type="text/javascript" src="/dist/music.js"></script>
</body>
</html>
